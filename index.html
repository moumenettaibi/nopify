<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nopify</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="https://api.cloudinary.com/v1_1/pplx/image/download?timestamp=1746370578&public_id=user_uploads%2F1428752%2FJdaGRckSlfmIJxu%2FSCR-20250504-nenx&format=jpg&signature=4cd38a510128955ae7b4be28a1ffbb21ccecb304&api_key=168798331147639" type="image/x-icon">
	<style>
        /* Custom Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa; /* Light gray background */
            line-height: 1.5; /* Improved readability */
            padding: 1rem; /* Add default padding to body */
        }

        /* Ensure the main container is centered and has responsive max-width */
        .main-container {
             width: 100%;
             max-width: 500px; /* Increased max-width slightly for desktop */
             margin-left: auto;
             margin-right: auto;
             padding: 1.5rem; /* Responsive padding */
             background-color: #fff;
             border-radius: 0.75rem; /* Slightly more rounded */
             box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); /* Medium shadow */
        }

        /* Style for calendar day circles */
        .calendar-day {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 36px; /* Fixed size for circles */
            height: 36px;
            border-radius: 50%; /* Make it circular */
            cursor: pointer; /* Changed to pointer to indicate clickability */
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.1s ease; /* Smooth transition */
            user-select: none; /* Prevent text selection */
            font-size: 0.875rem; /* text-sm */
            margin: 2px; /* Small margin for spacing */
        }
        .calendar-day:hover {
            transform: scale(1.05); /* Slight scale on hover */
            box-shadow: 0 0 0 2px rgba(253, 186, 116, 0.5); /* Orange ring on hover */
        }
        /* Adjust calendar day size on smaller screens if needed */
        @media (max-width: 360px) {
            .calendar-day {
                width: 30px;
                height: 30px;
                font-size: 0.75rem; /* text-xs */
            }
        }


        /* Style for days within the streak range - Reverted to previous orange */
        .streak-day {
            background-color: #fdba74; /* Orange-300 */
            color: #c2410c; /* Orange-700 */
            font-weight: bold;
        }
        /* Style for today's date */
        .today {
             border: 2px solid #fb923c; /* Orange-400 border */
        }
        /* Style for days from previous/next months */
        .other-month {
            color: #d1d5db; /* Gray-300 */
            cursor: default; /* Not clickable for other months */
        }
        .other-month:hover {
            transform: none; /* No scale on hover for other months */
            box-shadow: none; /* No shadow on hover for other months */
        }
        /* Style for calendar header (day names) */
        .calendar-header th {
            color: #6b7280; /* Gray-500 */
            font-weight: normal;
            padding-bottom: 8px;
            font-size: 0.75rem; /* text-xs */
        }
        /* Base button styling */
        .btn-base {
            padding: 0.75rem 1.5rem;
            /* Remove margin from here, use gap on parent for spacing */
            border-radius: 0.5rem;
            font-weight: 600; /* Semibold */
            transition: background-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out, transform 0.1s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Default shadow */
            display: inline-flex; /* For icon alignment */
            align-items: center;
            justify-content: center;
            flex-grow: 1; /* Allow buttons to grow and take available space */
            min-width: 120px; /* Ensure a minimum width for readability */
        }
        .btn-base:hover {
            transform: translateY(-2px); /* Slight lift on hover */
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15); /* Enhanced shadow on hover */
        }
        .btn-base:active {
            transform: translateY(0); /* Press down effect */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Reduced shadow on active */
        }

        /* Specific button variants */
        .btn-secondary {
            @apply bg-gray-200 text-gray-700;
        }
        .btn-secondary:hover {
            @apply bg-gray-300;
        }
        .btn-primary {
            @apply bg-orange-500 text-white;
        }
        .btn-primary:hover {
            @apply bg-orange-600;
        }
        .btn-danger {
            @apply bg-red-500 text-white;
        }
        .btn-danger:hover {
            @apply bg-red-600;
        }
        .btn-success {
            @apply bg-green-500 text-white;
        }
        .btn-success:hover {
            @apply bg-green-600;
        }


        /* Styling for date and number inputs */
        input[type="date"], input[type="number"], input[type="text"] { /* Added text input */
            padding: 0.5rem;
            border: 1px solid #d1d5db; /* Gray-300 border */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="date"]:focus, input[type="number"]:focus, input[type="text"]:focus {
            border-color: #f97316; /* Orange-500 on focus */
            box-shadow: 0 0 0 3px rgba(253, 186, 116, 0.5); /* Orange-300 ring on focus */
            outline: none; /* Remove default outline */
        }

        /* Styling for the main badge icon */
        .main-badge-icon {
            font-size: 1.75rem; /* Slightly larger */
            margin-right: 0.75rem;
            width: 28px; /* Fixed width for alignment */
            text-align: center;
            color: #fb923c; /* Default orange */
        }
        /* Modal overlay styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); /* Darker semi-transparent black */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        /* Modal content styles */
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); /* Stronger shadow */
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            transform: translateY(20px); /* Start slightly below center */
            transition: transform 0.3s ease;
        }
         .modal-overlay.active .modal-content {
             transform: translateY(0); /* Slide up to center */
         }
        /* Modal close button styles */
        .modal-close-btn {
            position: absolute;
            top: 0.5rem; /* Adjusted position */
            right: 0.5rem; /* Adjusted position */
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #9ca3af; /* Gray-400 */
            cursor: pointer;
            padding: 0.25rem;
            margin: 0;
            line-height: 1;
        }
        .modal-close-btn:hover {
            color: #4b5563; /* Gray-600 */
        }
        /* List item styling in modals (badges and goal) */
        .list-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 0.75rem; /* py-3 px-3 */
            border-bottom: 1px solid #e5e7eb; /* Gray-200 */
            transition: background-color 0.2s ease;
            list-style: none; /* Removed bullet points */
        }
        .list-item:last-child {
            border-bottom: none;
        }
        .list-item .item-icon {
             font-size: 1.75rem;
             margin-right: 1rem;
             width: 28px;
             text-align: center;
             color: #9ca3af; /* Gray-400 for unachieved icons */
        }
        .list-item-details {
            flex-grow: 1;
        }
        .list-item-name {
            font-weight: 600;
            color: #374151; /* Gray-700 */
        }
        .list-item-days {
            font-size: 0.875rem;
            color: #6b7280; /* Gray-500 */
        }
        /* Style for ACHIEVED items in lists */
        .list-item.achieved {
            background-color: #fff7ed; /* Orange-50 */
            border-left: 4px solid #f97316; /* Orange-500 */
            padding-left: calc(0.75rem - 4px); /* Adjust padding for border */
        }
        .list-item.achieved .item-icon {
            color: #f97316; /* Orange-500 */
        }
         .list-item.achieved .list-item-name {
            color: #c2410c; /* Orange-700 */
        }
        /* Styling for the Custom Goal item in the Achievements list */
         .list-item.goal-item .item-icon {
             color: #34d399; /* Green-400 */
         }
          .list-item.goal-item.achieved .item-icon {
             color: #047857; /* Green-800 */
         }
           .list-item.goal-item.achieved .list-item-name {
             color: #047857; /* Green-800 */
           }
            /* Styling for the Goal Achievement Badge items */
         .list-item.goal-achievement-item .item-icon {
             color: #059669; /* Green-600 */
         }
          .list-item.goal-achievement-item .list-item-name {
             color: #065f46; /* Green-800 */
         }


         /* Styling for the goal setting section within the modal */
         .modal-goal-section {
             margin-bottom: 1.5rem;
             padding: 1.5rem; /* Increased padding */
             border: 1px solid #d1d5db; /* Gray-300 border */
             border-radius: 0.5rem; /* Rounded corners */
             background-color: #f9fafb; /* Gray-50 */
             text-align: center;
             box-shadow: inset 0 1px 3px 0 rgba(0, 0, 0, 0.08); /* Subtle inner shadow */
         }
          .modal-goal-section label {
              display: block;
              margin-bottom: 0.75rem; /* Increased margin */
              font-size: 0.9rem; /* Slightly larger font */
              font-weight: 600; /* Semibold */
              color: #374151;
          }
          /* Specific style for the number input within the modal goal section */
           .modal-goal-section input[type="number"] {
               display: inline-block;
               width: auto;
               max-width: 120px; /* Increased max-width slightly */
               margin-bottom: 0.75rem; /* Increased margin */
               text-align: center;
               padding: 0.6rem; /* Increased padding */
               font-size: 1rem; /* Larger font size */
               border-color: #9ca3af; /* Gray-400 border */
               transition: border-color 0.2s ease, box-shadow 0.2s ease;
           }
            .modal-goal-section input[type="number"]:focus {
                border-color: #f97316; /* Orange-500 on focus */
                box-shadow: 0 0 0 3px rgba(253, 186, 116, 0.5); /* Orange-300 ring on focus */
                outline: none; /* Remove default outline */
            }
            /* Style for the goal name input */
            .modal-goal-section input[type="text"] {
                 display: inline-block;
                 width: calc(100% - 140px); /* Adjust width based on number input */
                 margin-left: 0.5rem;
                 margin-bottom: 0.75rem;
                 padding: 0.6rem;
                 font-size: 1rem;
                 border-color: #d1d5db;
                 transition: border-color 0.2s ease, box-shadow 0.2s ease;
            }
             .modal-goal-section input[type="text"]:focus {
                border-color: #f97316; /* Orange-500 on focus */
                box-shadow: 0 0 0 3px rgba(253, 186, 116, 0.5); /* Orange-300 ring on focus */
                outline: none; /* Remove default outline */
            }
            /* Style for the add goal button */
            .modal-goal-section button {
                display: block; /* Make button a block element */
                width: auto; /* Auto width */
                margin: 0.75rem auto 0 auto; /* Center the button */
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
                background-color: #fb923c; /* Orange-400 */
                color: white;
                font-weight: 600;
                border: none;
                border-radius: 0.375rem;
                cursor: pointer;
                transition: background-color 0.15s ease-in-out;
            }
             .modal-goal-section button:hover {
                 background-color: #f97316; /* Orange-500 on hover */
             }


          .modal-goal-progress {
              font-size: 0.9rem; /* Slightly larger font */
              color: #4b5563; /* Gray-600 */
              font-weight: 500;
              margin-bottom: 0.75rem; /* Added margin below text */
          }
           /* Added spacing between goal section and goal item */
          #customGoalAchievementItem {
              margin-top: 1.5rem;
          }

          /* New: Progress Bar Styling */
            .progress-bar-container {
                width: 100%; /* Full width of its container */
                height: 12px; /* Fixed height */
                background-color: #e5e7eb; /* Gray-200 background */
                border-radius: 6px; /* Rounded corners */
                overflow: hidden; /* Hide overflowing fill */
                margin-top: 0.5rem; /* Space above the bar */
                box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); /* Subtle inner shadow */
            }

            .progress-bar-fill {
                height: 100%;
                width: 0%; /* Start with 0 width */
                background-color: #fb923c; /* Orange-400 fill */
                border-radius: 6px;
                transition: width 0.5s ease-in-out; /* Smooth transition for width changes */
            }

            /* Style for achieved goal progress bar */
            .progress-bar-container.achieved .progress-bar-fill {
                background-color: #34d399; /* Green-400 when achieved */
            }

            /* Styling for the list of goals */
            #goalsListContainer {
                 margin-top: 1.5rem;
                 border-top: 1px solid #e5e7eb; /* Separator line */
                 padding-top: 1.5rem;
            }

            .goal-list-item {
                 display: flex;
                 flex-direction: column; /* Stack details and progress bar */
                 padding: 0.75rem 0.75rem;
                 border-bottom: 1px solid #e5e7eb;
                 list-style: none;
                 transition: background-color 0.2s ease;
            }
             .goal-list-item:last-child {
                 border-bottom: none;
             }
             .goal-list-item-header {
                 display: flex;
                 align-items: center;
                 margin-bottom: 0.5rem; /* Space between header and progress bar */
             }
             .goal-list-item .item-icon {
                 font-size: 1.5rem; /* Slightly smaller icon in list */
                 margin-right: 0.75rem;
                 width: 24px;
                 text-align: center;
                 color: #9ca3af;
             }
             .goal-list-item-details {
                 flex-grow: 1;
             }
              .goal-list-item-name {
                 font-weight: 600;
                 color: #374151;
              }
              .goal-list-item-progress-text {
                 font-size: 0.875rem;
                 color: #6b7280;
              }
              .goal-list-item .progress-bar-container {
                  margin-top: 0; /* Remove top margin from generic progress bar */
              }
               /* Style for achieved goal list item */
             .goal-list-item.achieved {
                 background-color: #d1fae5; /* Green-100 */
                 border-left: 4px solid #34d399; /* Green-400 */
                 padding-left: calc(0.75rem - 4px);
             }
              .goal-list-item.achieved .item-icon {
                 color: #047857; /* Green-800 */
              }
               .goal-list-item.achieved .goal-list-item-name {
                 color: #047857; /* Green-800 */
              }
              /* Style for the remove goal button */
              .remove-goal-btn {
                  background: none;
                  border: none;
                  color: #ef4444; /* Red-500 */
                  font-size: 1rem;
                  cursor: pointer;
                  margin-left: 0.5rem;
                  padding: 0;
                  line-height: 1;
              }
               .remove-goal-btn:hover {
                   color: #dc2626; /* Red-600 */
               }

        /* --- Celebration Modal Styles --- */
        #celebrationModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent dark background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Higher than other modals */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        #celebrationModal.active {
            opacity: 1;
            visibility: visible;
        }

        #celebrationContent {
            background: linear-gradient(to bottom right, #ffedd5, #fcd34d); /* Orange gradient */
            padding: 2rem;
            border-radius: 1rem; /* More rounded */
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3); /* Stronger shadow */
            transform: scale(0.8); /* Start slightly smaller */
            transition: transform 0.5s ease;
            color: #7c2d12; /* Dark orange text */
            font-weight: bold;
        }

        #celebrationModal.active #celebrationContent {
             transform: scale(1); /* Scale up to normal size */
        }

        #celebrationIcon {
            font-size: 4rem; /* Large icon */
            color: #f97316; /* Orange-500 */
            margin-bottom: 1rem;
            animation: pulse 1.5s infinite ease-in-out; /* Add pulse animation */
        }

         @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
         }


        #celebrationMessage {
            font-size: 1.5rem; /* Larger message text */
            margin-bottom: 0.5rem;
        }

        #celebrationDetails {
            font-size: 1.1rem; /* Slightly smaller details text */
            color: #9a3412; /* Darker orange */
        }

        /* --- Notification Permission Prompt Styles --- */
        #notificationPrompt {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #fff;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            text-align: center;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
         #notificationPrompt p {
             font-size: 0.9rem;
             color: #4b5563;
             margin-bottom: 0.75rem;
         }
          #requestNotificationPermissionBtn {
              @apply btn-base btn-success; /* Use new button style */
          }


        /* New: Relapse Day Style */
        .relapse-day {
            background-color: #fecaca; /* Red-200 */
            color: #dc2626; /* Red-600 */
            font-weight: bold;
            border: 2px solid #ef4444; /* Red-500 border */
        }

        /* New: LLM Relapse Insight Style */
        #llmRelapseInsight {
            font-style: italic;
            color: #4b5563; /* Gray-600 */
            margin-top: 1rem;
            font-size: 0.95rem;
            padding: 0.5rem;
            border-top: 1px dashed #d1d5db;
            border-bottom: 1px dashed #d1d5db;
        }

        /* Confirmation Modal Specific Styles */
        #confirmationModal .modal-content {
            max-width: 350px; /* Slightly smaller for confirmation */
        }
        #confirmationModal .modal-buttons {
            display: flex;
            justify-content: space-around;
            margin-top: 1.5rem;
        }
        #confirmationModal .modal-buttons button {
            flex-grow: 1; /* Make buttons fill space */
            margin: 0 0.5rem; /* Space between buttons */
        }

        /* Import/Settings Modal Specific Styles */
        #importModal .modal-content, #settingsModal .modal-content {
            max-width: 450px;
        }
        #importModal .file-input-wrapper, #settingsModal .file-input-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: border-color 0.2s ease, background-color 0.2s ease;
            text-align: center;
        }
        #importModal .file-input-wrapper:hover, #settingsModal .file-input-wrapper:hover {
            border-color: #fb923c;
            background-color: #fff7ed;
        }
        #importModal .file-input-wrapper input[type="file"], #settingsModal .file-input-wrapper input[type="file"] {
            display: none; /* Hide actual file input */
        }
        #importModal .file-input-wrapper .file-input-text, #settingsModal .file-input-wrapper .file-input-text {
            color: #6b7280;
            font-size: 0.95rem;
        }
        #importModal .file-input-wrapper .file-input-icon, #settingsModal .file-input-wrapper .file-input-icon {
            font-size: 2rem;
            color: #9ca3af;
            margin-bottom: 0.5rem;
        }
        #importModal .import-status, #settingsModal .import-status {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #4b5563;
        }
        #importModal .import-error, #settingsModal .import-error {
            color: #ef4444;
            font-weight: 500;
        }
        #importModal .import-success, #settingsModal .import-success {
            color: #22c55e;
            font-weight: 500;
        }

        /* Settings Modal specific layout */
        #settingsModal .modal-content div {
            margin-bottom: 1rem; /* Spacing between sections */
        }
        #settingsModal .modal-content button {
            margin-top: 0.5rem; /* Spacing below buttons within settings */
        }

    </style>
</head>
<body class="flex flex-col items-center justify-start min-h-screen p-4 bg-gray-100">

    <div class="main-container">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Nopify</h1>

        <div class="mb-6 text-center">
            <label for="startDate" class="block text-sm font-medium text-gray-700 mb-2">Start Date:</label>
            <input type="date" id="startDate" name="startDate" class="mx-auto block">
        </div>

        <div class="text-center mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
             <div class="flex items-center justify-center space-x-4 mb-2">
                 <span id="streakCount" class="text-6xl font-bold text-orange-500">0</span>
                 <i class="fas fa-fire text-5xl text-orange-400"></i>
            </div>
            <p class="text-lg text-gray-700">Days Streak!</p>
            <div id="badgeDisplay" class="mt-3 flex items-center justify-center text-gray-600">
                <i id="badgeIcon" class="main-badge-icon fas fa-question-circle"></i>
                <span id="badgeName" class="font-medium">Set start date</span>
            </div>
            <p id="streakMessage" class="text-sm text-gray-500 mt-1"></p>
        </div>

        <div class="mt-6 text-center flex flex-wrap justify-center items-center gap-2 sm:gap-4">
             <button id="myGoalsBtn" class="btn-base btn-secondary w-full sm:w-auto">
                <i class="fas fa-bullseye mr-2"></i>My Goals
            </button>
             <button id="myGoalAchievementsBtn" class="btn-base btn-secondary w-full sm:w-auto">
                <i class="fas fa-award mr-2"></i>My Achievements
            </button>
             <button id="viewStandardBadgesBtn" class="btn-base btn-secondary w-full sm:w-auto">
                <i class="fas fa-trophy mr-2"></i>View All Badges
            </button>
            <button id="relapseBtn" class="btn-base btn-danger w-full sm:w-auto">
                <i class="fas fa-skull-crossbones mr-2"></i>Relapse
            </button>
            <button id="settingsBtn" class="btn-base btn-secondary w-full sm:w-auto">
                <i class="fas fa-cog mr-2"></i>Settings
            </button>
        </div>

        <div id="notificationPrompt" class="hidden mt-6">
            <p>Enable browser notifications to get alerts when you achieve milestones!</p>
            <button id="requestNotificationPermissionBtn">Enable Notifications</button>
        </div>


        <div class="mt-8">
            <h2 class="text-xl font-semibold text-center text-gray-800 mb-4">Streak Calendar</h2>
            <div class="flex items-center justify-between mb-4 px-2">
                <button id="prevMonth" aria-label="Previous month" class="text-gray-600 hover:text-orange-500 transition duration-150 ease-in-out p-2 rounded-full">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h3 id="currentMonthYear" class="text-lg font-medium text-gray-700">Month Year</h3>
                <button id="nextMonth" aria-label="Next month" class="text-gray-600 hover:text-orange-500 transition duration-150 ease-in-out p-2 rounded-full">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <table class="w-full table-fixed">
                <thead class="calendar-header">
                    <tr>
                        <th class="text-center">Mo</th>
                        <th class="text-center">Tu</th>
                        <th class="text-center">We</th>
                        <th class="text-center">Th</th>
                        <th class="text-center">Fr</th>
                        <th class="text-center">Sa</th>
                        <th class="text-center">Su</th>
                    </tr>
                </thead>
                <tbody id="calendarBody" class="text-center">
                    </tbody>
            </table>
        </div>

    </div>

    <div id="myGoalsModal" class="modal-overlay">
        <div class="modal-content">
            <button id="closeGoalsModalBtn" aria-label="Close modal" class="modal-close-btn">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="text-xl font-semibold text-center text-gray-800 mb-4">My Goals</h2>

            <div class="modal-goal-section">
                <label for="newGoalDays">Add New Goal:</label>
                <div class="flex flex-col sm:flex-row items-center justify-center gap-2 mb-2">
                    <input type="number" id="newGoalDays" name="newGoalDays" min="1" placeholder="Days" class="block w-full sm:w-auto max-w-[100px] text-center">
                    <input type="text" id="newGoalName" name="newGoalName" placeholder="Optional Name" class="block w-full sm:flex-grow">
                </div>
                <button id="addGoalBtn" class="btn-base btn-primary w-full sm:w-auto"> Add Goal
                </button>
            </div>

            <div id="goalsListContainer">
                <p class="text-center text-gray-500 text-sm italic p-4">No goals set yet. Add one above!</p>
                </div>
        </div>
    </div>

    <div id="myGoalAchievementsModal" class="modal-overlay">
        <div class="modal-content">
            <button id="closeGoalAchievementsModalBtn" aria-label="Close modal" class="modal-close-btn">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="text-xl font-semibold text-center text-gray-800 mb-4">My Goal Achievements</h2>
            <div id="goalAchievementsListContainer">
                 <p class="text-center text-gray-500 text-sm italic p-4">No goals achieved yet.</p>
                 </div>
        </div>
    </div>

    <div id="viewStandardBadgesModal" class="modal-overlay">
        <div class="modal-content">
            <button id="closeStandardBadgesModalBtn" aria-label="Close modal" class="modal-close-btn">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="text-xl font-semibold text-center text-gray-800 mb-4">All Standard Badges</h2>
            <div id="standardBadgesListContainer">
                 </div>
        </div>
    </div>

    <div id="celebrationModal" class="modal-overlay">
        <div id="celebrationContent">
            <i id="celebrationIcon" class="fas fa-star"></i>
            <div id="celebrationMessage">Congratulations!</div>
            <div id="celebrationDetails">You achieved a milestone!</div>
            <div id="llmRelapseInsight" class="text-sm text-gray-700 mt-2 hidden"></div>
        </div>
    </div>

    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="confirmationMessage" class="text-lg font-semibold text-center text-gray-800 mb-4">Are you sure?</h3>
            <div class="modal-buttons">
                <button id="confirmYesBtn" class="btn-base btn-danger">Yes</button>
                <button id="confirmNoBtn" class="btn-base btn-secondary">No</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <button id="closeSettingsModalBtn" aria-label="Close modal" class="modal-close-btn">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="text-xl font-semibold text-center text-gray-800 mb-4">Settings</h2>

            <div class="flex flex-col items-center mb-4">
                <h3 class="text-lg font-medium text-gray-700 mb-2">Data Management</h3>
                <button id="exportDataBtn" class="btn-base btn-secondary w-full mb-2">
                    <i class="fas fa-download mr-2"></i>Export Data
                </button>
                <button id="importDataBtn" class="btn-base btn-secondary w-full">
                    <i class="fas fa-upload mr-2"></i>Import Data
                </button>
            </div>

            <input type="file" id="importFileInput" accept=".json" class="hidden">
            <div id="importStatus" class="import-status text-center mt-4 hidden"></div>
            <button id="performImportBtn" class="btn-base btn-primary w-full mt-4 hidden">Perform Import</button>

        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const startDateInput = document.getElementById('startDate');
        const streakCountEl = document.getElementById('streakCount');
        const streakMessageEl = document.getElementById('streakMessage');
        const calendarBody = document.getElementById('calendarBody');
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const badgeIconEl = document.getElementById('badgeIcon');
        const badgeNameEl = document.getElementById('badgeName');
        const relapseBtn = document.getElementById('relapseBtn');

        // Buttons to open modals
        const myGoalsBtn = document.getElementById('myGoalsBtn');
        const myGoalAchievementsBtn = document.getElementById('myGoalAchievementsBtn');
        const viewStandardBadgesBtn = document.getElementById('viewStandardBadgesBtn');
        const settingsBtn = document.getElementById('settingsBtn'); // New: Settings Button

        // Notification Permission Prompt Elements
        const notificationPrompt = document.getElementById('notificationPrompt');
        const requestNotificationPermissionBtn = document.getElementById('requestNotificationPermissionBtn');

        // Modals
        const myGoalsModal = document.getElementById('myGoalsModal');
        const myGoalAchievementsModal = document.getElementById('myGoalAchievementsModal');
        const viewStandardBadgesModal = document.getElementById('viewStandardBadgesModal');
        const celebrationModal = document.getElementById('celebrationModal');
        const confirmationModal = document.getElementById('confirmationModal');
        const settingsModal = document.getElementById('settingsModal'); // New: Settings Modal

        // Close buttons for modals
        const closeGoalsModalBtn = myGoalsModal.querySelector('.modal-close-btn');
        const closeGoalAchievementsModalBtn = myGoalAchievementsModal.querySelector('.modal-close-btn');
        const closeStandardBadgesModalBtn = viewStandardBadgesModal.querySelector('.modal-close-btn');
        const closeSettingsModalBtn = settingsModal.querySelector('.modal-close-btn'); // New: Close Settings Modal Button

        // Elements within My Goals Modal
        const newGoalDaysInput = document.getElementById('newGoalDays');
        const newGoalNameInput = document.getElementById('newGoalName');
        const addGoalBtn = document.getElementById('addGoalBtn');
        const goalsListContainer = document.getElementById('goalsListContainer');

        // Elements within My Goal Achievements Modal
        const goalAchievementsListContainer = document.getElementById('goalAchievementsListContainer');

        // Elements within View All Standard Badges Modal
        const standardBadgesListContainer = document.getElementById('standardBadgesListContainer');

        // Elements within Celebration Modal
        const celebrationIconEl = document.getElementById('celebrationIcon');
        const celebrationMessageEl = document.getElementById('celebrationMessage');
        const celebrationDetailsEl = document.getElementById('celebrationDetails');
        const llmRelapseInsightEl = document.getElementById('llmRelapseInsight');

        // Elements within Confirmation Modal
        const confirmationMessageEl = document.getElementById('confirmationMessage');
        const confirmYesBtn = document.getElementById('confirmYesBtn');
        const confirmNoBtn = document.getElementById('confirmNoBtn');

        // Elements within Settings Modal (moved from main and importModal)
        const exportDataBtn = document.getElementById('exportDataBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const importFileInput = document.getElementById('importFileInput');
        const importStatusEl = document.getElementById('importStatus');
        const performImportBtn = document.getElementById('performImportBtn');


        // --- State ---
        let currentDisplayedDate = new Date();
        let streakStartDate = null;
        let currentStreakDays = 0;
        let userGoals = [];
        let lastAchievedStandardBadgeThreshold = 0;
        let dailyUpdateTimeoutId = null;
        let relapseDates = [];
        let pendingConfirmationCallback = null;
        let importedData = null;


        // --- Constants ---
        const MS_PER_DAY = 1000 * 60 * 60 * 24;
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        // --- Badge Definitions ---
        const badges = [
             { name: 'Clown', threshold: 0, icon: 'fa-face-sad-tear' },
             { name: 'Noob', threshold: 1, icon: 'fa-baby' },
             { name: 'Novice', threshold: 3, icon: 'fa-seedling' },
             { name: 'Average', threshold: 7, icon: 'fa-medal' },
             { name: 'Advanced', threshold: 15, icon: 'fa-rocket' },
             { name: 'Sigma', threshold: 30, icon: 'fa-star' },
             { name: 'Chad', threshold: 45, icon: 'fa-user-astronaut' },
             { name: 'Absolute Chad', threshold: 60, icon: 'fa-gem' },
             { name: 'Giga Chad', threshold: 120, icon: 'fa-crown' },
             { name: 'Absolute Giga Chad', threshold: 365, icon: 'fa-meteor' }
        ].sort((a, b) => b.threshold - a.threshold);

        // --- Functions ---

        /** Calculates the difference in days between two dates (UTC). */
        function dateDiffInDays(date1, date2) {
            const utc1 = Date.UTC(date1.getFullYear(), date1.getMonth(), date1.getDate());
            const utc2 = Date.UTC(date2.getFullYear(), date2.getMonth(), date2.getDate());
            const diff = Math.floor((utc2 - utc1) / MS_PER_DAY);
            return diff;
        }

        /** Normalizes a date to midnight UTC for consistent comparison. */
        function normalizeDateToUTC(date) {
            return new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        }

        /** Checks if a date is a relapse date. */
        function isRelapseDate(date) {
            const normalizedDate = normalizeDateToUTC(date);
            return relapseDates.some(relapseIso => normalizeDateToUTC(new Date(relapseIso)).getTime() === normalizedDate.getTime());
        }

        /** Determines the *highest* current badge achieved based on days. */
        function getCurrentBadge(days) {
             for (const badge of badges) {
                 if (days >= badge.threshold) {
                     return badge;
                 }
             }
             return badges[badges.length - 1];
        }

        /** Populates the standard badges list within the View All Standard Badges modal. */
        function populateStandardBadgesList() {
            standardBadgesListContainer.innerHTML = '';

            const sortedBadgesForDisplay = [...badges].sort((a, b) => a.threshold - b.threshold);

            if (sortedBadgesForDisplay.length === 0) {
                 standardBadgesListContainer.innerHTML = '<p class="text-center text-gray-500 text-sm italic p-4">No standard badges defined.</p>';
                 return;
            }

            sortedBadgesForDisplay.forEach(badge => {
                const listItem = document.createElement('div');
                listItem.className = 'list-item';
                const isAchieved = currentStreakDays >= badge.threshold && currentStreakDays >= 0;

                if (isAchieved) {
                    listItem.classList.add('achieved');
                }

                listItem.innerHTML = `
                    <i class="item-icon fas ${badge.icon}"></i>
                    <div class="list-item-details">
                        <div class="list-item-name">${badge.name}</div>
                        <div class="list-item-days">${badge.threshold}+ Days</div>
                    </div>
                `;
                standardBadgesListContainer.appendChild(listItem);
            });
        }

         /** Renders the list of user-defined goals in the My Goals modal. */
        function renderGoalsList() {
             goalsListContainer.innerHTML = '';

            if (userGoals.length === 0) {
                 goalsListContainer.innerHTML = '<p class="text-center text-gray-500 text-sm italic p-4">No goals set yet. Add one above!</p>';
                 return;
            }

             userGoals.sort((a, b) => a.days - b.days);

            userGoals.forEach((goal, index) => {
                const goalItem = document.createElement('div');
                goalItem.className = 'goal-list-item';
                const isGoalAchieved = currentStreakDays >= goal.days && currentStreakDays >= 0;

                 if (isGoalAchieved) {
                     goalItem.classList.add('achieved');
                 }

                const percentage = isGoalAchieved ? 100 : (currentStreakDays > 0 ? Math.min((currentStreakDays / goal.days) * 100, 100) : 0);

                goalItem.innerHTML = `
                    <div class="goal-list-item-header">
                         <i class="item-icon fas fa-bullseye"></i>
                         <div class="goal-list-item-details">
                             <div class="goal-list-item-name">${goal.name ? goal.name : `Goal ${goal.days} Days`} (${goal.days} Days)</div>
                             <div class="list-item-progress-text">${isGoalAchieved ? 'Achieved!' : `Progress: ${Math.max(0, currentStreakDays)} / ${goal.days} days`}</div>
                         </div>
                         <button class="remove-goal-btn" data-index="${index}" aria-label="Remove goal">
                             <i class="fas fa-times-circle"></i>
                         </button>
                    </div>
                    <div class="progress-bar-container ${isGoalAchieved ? 'achieved' : ''}">
                        <div class="progress-bar-fill" style="width: ${percentage}%;"></div>
                    </div>
                `;
                goalsListContainer.appendChild(goalItem);
            });

             goalsListContainer.querySelectorAll('.remove-goal-btn').forEach(button => {
                 button.addEventListener('click', handleRemoveGoal);
             });
        }

        /** Renders the list of achieved user-defined goals in the My Goal Achievements modal. */
        function renderGoalAchievements() {
            goalAchievementsListContainer.innerHTML = '';

            const achievedGoals = userGoals.filter(goal => goal.isAchieved);

            if (achievedGoals.length === 0) {
                 goalAchievementsListContainer.innerHTML = '<p class="text-center text-gray-500 text-sm italic p-4">No goals achieved yet.</p>';
                 return;
            }

            achievedGoals.sort((a, b) => a.days - b.days);

            achievedGoals.forEach(goal => {
                 const achievementItem = document.createElement('div');
                 achievementItem.className = 'list-item goal-achievement-item achieved';
                 achievementItem.innerHTML = `
                     <i class="item-icon fas fa-award"></i>
                     <div class="list-item-details">
                         <div class="list-item-name">Achieved: ${goal.name ? goal.name : `Goal ${goal.days} Days`}</div>
                         <div class="list-item-days">Reached at ${goal.days} days</div>
                     </div>
                 `;
                 goalAchievementsListContainer.appendChild(achievementItem);
            });
        }

        /** Displays a celebration message pop-up. */
        function showCelebration(message, details, iconClass = 'fa-star', llmInsight = '') {
            celebrationMessageEl.textContent = message;
            celebrationDetailsEl.textContent = details;
            celebrationIconEl.className = `fas ${iconClass} text-4xl mb-4`;

            if (llmInsight) {
                llmRelapseInsightEl.textContent = llmInsight;
                llmRelapseInsightEl.classList.remove('hidden');
            } else {
                llmRelapseInsightEl.classList.add('hidden');
                llmRelapseInsightEl.textContent = '';
            }

            celebrationModal.classList.add('active');

            setTimeout(() => {
                celebrationModal.classList.remove('active');
            }, 4000);
        }

        /** Sends a browser notification if permission is granted. */
        function sendNotification(title, body, icon = 'https://api.cloudinary.com/v1_1/pplx/image/download?timestamp=1746370578&public_id=user_uploads%2F1428752%2FJdaGRckSlfmIJxu%2FSCR-20250504-nenx&format=jpg&signature=4cd38a510128955ae7b4be28a1ffbb21ccecb304&api_key=168798331147639') {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body: body, icon: icon });
            }
        }

        /** Fetches a motivational message from the Gemini API. */
        async function getMotivationalMessage() {
            llmRelapseInsightEl.classList.remove('hidden');
            llmRelapseInsightEl.textContent = 'Generating a motivational message...';
            try {
                let chatHistory = [];
                const prompt = "Generate a very short, encouraging, and empathetic message for someone who has experienced a relapse in their self-improvement journey. Focus on resilience and moving forward. Keep it under 20 words.";
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = "AIzaSyCKcbHo3lbOzPL5k7hI1IsU5D8XtLkFODA";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    llmRelapseInsightEl.textContent = text;
                } else {
                    llmRelapseInsightEl.textContent = 'Failed to get insight. Please try again.';
                    console.error("Gemini API response structure unexpected:", result);
                }
            } catch (error) {
                llmRelapseInsightEl.textContent = 'Error generating message.';
                console.error("Error calling Gemini API:", error);
            }
        }

        /** Checks user goals against the current streak and updates their achievement status. */
        function checkAndAwardGoalBadges() {
            let stateChanged = false;
            let newlyAchievedGoal = null;

            userGoals.forEach(goal => {
                if (!goal.isAchieved && currentStreakDays >= goal.days && currentStreakDays >= 0) {
                    goal.isAchieved = true;
                    stateChanged = true;
                    newlyAchievedGoal = goal;
                }
            });

            if (newlyAchievedGoal) {
                 const goalName = newlyAchievedGoal.name ? newlyAchievedGoal.name : `${newlyAchievedGoal.days} Days Goal`;
                 showCelebration('Goal Achieved!', goalName, 'fa-award');
                 sendNotification('Milestone Achieved!', `You reached your goal: ${goalName}!`);
            }

            renderGoalsList();
            renderGoalAchievements();

            if (stateChanged) {
                saveState();
            }
        }

        /** Updates the main streak count and current badge display. */
        function updateMainDisplay() {
            const today = normalizeDateToUTC(new Date());

            let previousStreakDays = currentStreakDays;
            let newlyAchievedStandardBadge = null;

            currentStreakDays = 0;
            let currentBadge = getCurrentBadge(0);

            if (streakStartDate) {
                const normalizedStartDate = normalizeDateToUTC(streakStartDate);

                if (normalizedStartDate > today) {
                    currentStreakDays = -1;
                    currentBadge = { name: 'Invalid Date', icon: 'fa-exclamation-triangle' };
                    streakMessageEl.textContent = 'Start date cannot be in the future.';
                    badgeIconEl.style.color = '#ef4444';
                } else {
                    currentStreakDays = dateDiffInDays(normalizedStartDate, today);
                    currentBadge = getCurrentBadge(currentStreakDays);
                    streakMessageEl.textContent = '';
                    badgeIconEl.style.color = '#f97316';

                    if (currentStreakDays > previousStreakDays && currentBadge.threshold > lastAchievedStandardBadgeThreshold && currentBadge.threshold <= currentStreakDays) {
                         newlyAchievedStandardBadge = currentBadge;
                         lastAchievedStandardBadgeThreshold = currentBadge.threshold;
                         saveState();
                    }
                }
            } else {
                currentStreakDays = 0;
                currentBadge = { name: 'Set start date', icon: 'fa-question-circle' };
                streakMessageEl.textContent = '';
                badgeIconEl.style.color = '#fb923c';
                lastAchievedStandardBadgeThreshold = 0;
                saveState();
            }

            streakCountEl.textContent = Math.max(0, currentStreakDays);

            if (currentStreakDays > 0) {
                document.title = `${currentStreakDays} Days Streak - Nopify`;
            } else if (currentStreakDays === 0 && streakStartDate !== null) {
                 document.title = `0 Day Streak - Nopify`;
            } else {
                 document.title = `Nopify`;
            }

            badgeNameEl.textContent = currentBadge.name;
            badgeIconEl.className = `main-badge-icon fas ${currentBadge.icon}`;

            checkAndAwardGoalBadges();

            if (newlyAchievedStandardBadge) {
                 showCelebration('New Badge!', newlyAchievedStandardBadge.name, newlyAchievedStandardBadge.icon);
                 sendNotification('New Badge Unlocked!', `You earned the ${newlyAchievedStandardBadge.name} badge for ${newlyAchievedStandardBadge.threshold} days!`);
            }

            populateStandardBadgesList();
        }


        /** Generates and displays the calendar for a given month and year. */
        function generateCalendar(year, month) {
            calendarBody.innerHTML = '';
            const today = normalizeDateToUTC(new Date());

            currentMonthYearEl.textContent = `${monthNames[month]} ${year}`;

            const firstDayOfMonth = new Date(year, month, 1);
            let startingDay = firstDayOfMonth.getDay();
            startingDay = (startingDay === 0) ? 6 : startingDay - 1;

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let date = 1;
            let calendarHtml = '';

            let normalizedStartDate = null;
            if (streakStartDate) {
                normalizedStartDate = normalizeDateToUTC(streakStartDate);
            }

            for (let i = 0; i < 6; i++) {
                calendarHtml += '<tr>';
                let rowHasDates = false;

                for (let j = 0; j < 7; j++) {
                    if ((i === 0 && j < startingDay) || date > daysInMonth) {
                        calendarHtml += '<td><div class="calendar-day other-month"></div></td>';
                    } else {
                        rowHasDates = true;
                        const currentDate = normalizeDateToUTC(new Date(year, month, date));

                        let classes = 'calendar-day';

                        if (normalizedStartDate && currentDate >= normalizedStartDate && currentDate <= today) {
                            classes += ' streak-day';
                        }

                        if (isRelapseDate(currentDate)) {
                            classes = 'calendar-day relapse-day';
                        }

                        if (currentDate.getTime() === today.getTime()) {
                            classes += ' today';
                        }

                        // Add data attribute for easy date retrieval on click
                        calendarHtml += `<td><div class="${classes}" data-full-date="${currentDate.toISOString()}">${date}</div></td>`;
                        date++;
                    }
                }
                calendarHtml += '</tr>';

                if (date > daysInMonth && !rowHasDates) {
                    break;
                }
            }
            calendarBody.innerHTML = calendarHtml;

            // Add event listeners to each clickable day
            calendarBody.querySelectorAll('.calendar-day:not(.other-month)').forEach(dayEl => {
                dayEl.addEventListener('click', handleCalendarDayClick);
            });
        }

        /** Saves the streak start date, goals, last badge threshold, and relapse dates to localStorage. */
        function saveState() {
            try {
                const appState = {
                    streakStartDate: streakStartDate ? streakStartDate.toISOString() : null,
                    userGoals: userGoals,
                    lastAchievedStandardBadgeThreshold: lastAchievedStandardBadgeThreshold,
                    relapseDates: relapseDates
                };
                localStorage.setItem('nopify_appState', JSON.stringify(appState));
            } catch (e) {
                console.error("Error saving state to localStorage:", e);
                showCelebration('Save Error', 'Could not save progress. LocalStorage might be full or disabled.', 'fa-exclamation-triangle');
            }
        }

        /** Loads the state from localStorage. */
        function loadState() {
            try {
                const savedStateString = localStorage.getItem('nopify_appState');
                if (savedStateString) {
                    const appState = JSON.parse(savedStateString);

                    // Basic validation for loaded data
                    if (appState.streakStartDate) {
                        const date = new Date(appState.streakStartDate);
                        if (!isNaN(date.getTime())) {
                            streakStartDate = date;
                            startDateInput.value = streakStartDate.toISOString().split('T')[0];
                        } else {
                            console.warn("Invalid streakStartDate in saved state.");
                            streakStartDate = null;
                            startDateInput.value = '';
                        }
                    } else {
                        streakStartDate = null;
                        startDateInput.value = '';
                    }

                    if (Array.isArray(appState.userGoals) && appState.userGoals.every(g => typeof g.days === 'number' && typeof g.isAchieved === 'boolean')) {
                        userGoals = appState.userGoals;
                    } else {
                        console.warn("Invalid userGoals in saved state. Resetting.");
                        userGoals = [];
                    }

                    if (typeof appState.lastAchievedStandardBadgeThreshold === 'number') {
                        lastAchievedStandardBadgeThreshold = appState.lastAchievedStandardBadgeThreshold;
                    } else {
                        console.warn("Invalid lastAchievedStandardBadgeThreshold in saved state. Resetting.");
                        lastAchievedStandardBadgeThreshold = 0;
                    }

                    if (Array.isArray(appState.relapseDates) && appState.relapseDates.every(d => typeof d === 'string')) {
                        relapseDates = appState.relapseDates;
                    } else {
                        console.warn("Invalid relapseDates in saved state. Resetting.");
                        relapseDates = [];
                    }
                } else {
                    // No saved state found, initialize defaults
                    streakStartDate = null;
                    userGoals = [];
                    lastAchievedStandardBadgeThreshold = 0;
                    relapseDates = [];
                    startDateInput.value = '';
                }

            } catch (e) {
                console.error("Error loading state from localStorage:", e);
                // Reset to defaults on error
                streakStartDate = null;
                userGoals = [];
                lastAchievedStandardBadgeThreshold = 0;
                relapseDates = [];
                startDateInput.value = '';
                showCelebration('Load Error', 'Could not load saved progress. Starting fresh.', 'fa-exclamation-triangle');
            }

            updateMainDisplay();
            generateCalendar(currentDisplayedDate.getFullYear(), currentDisplayedDate.getMonth());
            checkNotificationPermission();
        }

        /** Checks notification permission and updates the UI prompt. */
        function checkNotificationPermission() {
             if (!('Notification' in window)) {
                notificationPrompt.style.display = 'none';
            } else if (Notification.permission === 'granted') {
                notificationPrompt.style.display = 'none';
            } else if (Notification.permission === 'denied') {
                 notificationPrompt.style.display = 'none';
            } else {
                notificationPrompt.style.display = 'block';
            }
        }

        /** Function to run the daily update */
        function runDailyUpdate() {
            updateMainDisplay();
            const now = new Date();
            if (currentDisplayedDate.getFullYear() === now.getFullYear() &&
                currentDisplayedDate.getMonth() === now.getMonth()) {
                generateCalendar(currentDisplayedDate.getFullYear(), currentDisplayedDate.getMonth());
            }
            scheduleDailyUpdate();
        }

        /** Calculates time until next midnight and sets timeout */
        function scheduleDailyUpdate() {
            if (dailyUpdateTimeoutId) {
                clearTimeout(dailyUpdateTimeoutId);
            }

            const now = new Date();
            const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 1, 0, 0);
            const msUntilMidnight = tomorrow.getTime() - now.getTime();

            dailyUpdateTimeoutId = setTimeout(runDailyUpdate, msUntilMidnight);
        }

        /** Shows the custom confirmation modal. */
        function showConfirmation(message, onConfirm, onCancel) {
            confirmationMessageEl.textContent = message;
            pendingConfirmationCallback = { onConfirm, onCancel };
            confirmationModal.classList.add('active');
        }

        /** Hides the custom confirmation modal. */
        function hideConfirmation() {
            confirmationModal.classList.remove('active');
            pendingConfirmationCallback = null;
        }

        /** Handles the confirmation for adding a relapse. */
        function confirmAndAddRelapse(date) {
            const formattedDate = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            showConfirmation(`Mark ${formattedDate} as a relapse?`, () => {
                addRelapseDate(date);
                hideConfirmation();
            }, () => {
                hideConfirmation();
            });
        }

        /** Adds a relapse date to the state and updates UI. */
        async function addRelapseDate(date) {
            const today = normalizeDateToUTC(new Date());
            const normalizedDate = normalizeDateToUTC(date);
            const dateIso = normalizedDate.toISOString();

            if (normalizedDate > today) {
                showCelebration('Cannot Mark Relapse', 'You cannot mark a relapse in the future.', 'fa-calendar-times');
                return;
            }
            if (!streakStartDate || normalizedDate < normalizeDateToUTC(streakStartDate)) {
                showCelebration('Cannot Mark Relapse', 'Relapse date cannot be before your streak start date.', 'fa-calendar-times');
                return;
            }
            if (relapseDates.includes(dateIso)) {
                showCelebration('Already Marked', `${normalizedDate.toLocaleDateString('en-US')} is already marked as a relapse.`, 'fa-info-circle');
                return;
            }

            relapseDates.push(dateIso);
            saveState();
            generateCalendar(currentDisplayedDate.getFullYear(), currentDisplayedDate.getMonth());

            showCelebration('Relapse Recorded', 'Keep going, every day is a new chance!', 'fa-skull-crossbones');
            sendNotification('Relapse Recorded', 'Don\'t give up! Your streak continues.');
            await getMotivationalMessage();
        }

        /** Exports current app data to a JSON file. */
        function exportData() {
            const appState = {
                streakStartDate: streakStartDate ? streakStartDate.toISOString() : null,
                userGoals: userGoals,
                lastAchievedStandardBadgeThreshold: lastAchievedStandardBadgeThreshold,
                relapseDates: relapseDates
            };
            const dataStr = JSON.stringify(appState, null, 2); // Pretty print JSON
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nopify_data_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a); // Required for Firefox
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // Clean up
            showCelebration('Data Exported!', 'Your Nopify data has been downloaded.', 'fa-file-export');
            settingsModal.classList.remove('active'); // Close settings modal after export
        }

        /** Handles the import of data from a JSON file. */
        function importData() {
            importStatusEl.textContent = ''; // Clear previous status
            performImportBtn.classList.add('hidden'); // Hide import button initially
            importFileInput.value = ''; // Clear selected file
            importFileInput.click(); // Programmatically click the hidden file input
        }

        /** Validates and applies imported data. */
        function applyImportedData(data) {
            // Basic validation of the imported data structure
            if (typeof data !== 'object' || data === null ||
                !('streakStartDate' in data) || !('userGoals' in data) ||
                !('lastAchievedStandardBadgeThreshold' in data) || !('relapseDates' in data)) {
                importStatusEl.textContent = 'Invalid data structure in file.';
                importStatusEl.classList.remove('import-success');
                importStatusEl.classList.add('import-error');
                return false;
            }

            // More detailed validation for each property
            let isValid = true;
            if (data.streakStartDate !== null) {
                const date = new Date(data.streakStartDate);
                if (isNaN(date.getTime())) {
                    isValid = false;
                    importStatusEl.textContent = 'Invalid streak start date format.';
                }
            }
            if (!Array.isArray(data.userGoals) || !data.userGoals.every(g => typeof g.days === 'number' && typeof g.isAchieved === 'boolean')) {
                isValid = false;
                importStatusEl.textContent = 'Invalid user goals format.';
            }
            if (typeof data.lastAchievedStandardBadgeThreshold !== 'number') {
                isValid = false;
                importStatusEl.textContent = 'Invalid badge threshold format.';
            }
            if (!Array.isArray(data.relapseDates) || !data.relapseDates.every(d => typeof d === 'string')) {
                isValid = false;
                importStatusEl.textContent = 'Invalid relapse dates format.';
            }

            if (!isValid) {
                importStatusEl.classList.remove('import-success');
                importStatusEl.classList.add('import-error');
                return false;
            }

            // If validation passes, update the state
            streakStartDate = data.streakStartDate ? new Date(data.streakStartDate) : null;
            userGoals = data.userGoals;
            lastAchievedStandardBadgeThreshold = data.lastAchievedStandardBadgeThreshold;
            relapseDates = data.relapseDates;

            saveState(); // Save the newly imported state
            updateMainDisplay(); // Refresh main UI
            generateCalendar(currentDisplayedDate.getFullYear(), currentDisplayedDate.getMonth()); // Refresh calendar

            importStatusEl.textContent = 'Data imported successfully!';
            importStatusEl.classList.remove('import-error');
            importStatusEl.classList.add('import-success');
            performImportBtn.classList.add('hidden'); // Hide button after successful import
            importedData = null; // Clear imported data
            return true;
        }

        // --- Event Handlers ---

        /** Handles adding a new goal. */
        function handleAddGoal() {
            const days = parseInt(newGoalDaysInput.value, 10);
            const name = newGoalNameInput.value.trim();

            if (isNaN(days) || days <= 0) {
                showCelebration('Invalid Input', 'Please enter a valid positive number of days for your goal.', 'fa-exclamation-circle');
                return;
            }
            if (userGoals.some(goal => goal.days === days)) {
                showCelebration('Goal Exists', `A goal for ${days} days already exists.`, 'fa-info-circle');
                return;
            }

            const newGoal = { days: days, name: name || `Goal ${days} Days`, isAchieved: false };
            userGoals.push(newGoal);

            saveState();
            renderGoalsList();
            checkAndAwardGoalBadges();

            newGoalDaysInput.value = '';
            newGoalNameInput.value = '';
        }

        /** Handles removing a goal from the list. */
        function handleRemoveGoal(event) {
             const button = event.target.closest('.remove-goal-btn');
             if (!button) return;

             const indexToRemove = parseInt(button.dataset.index, 10);

             const sortedGoals = [...userGoals].sort((a, b) => a.days - b.days);
             if (indexToRemove >= 0 && indexToRemove < sortedGoals.length) {
                 const goalToRemove = sortedGoals[indexToRemove];
                 const originalIndex = userGoals.findIndex(g => g.days === goalToRemove.days);
                 if (originalIndex !== -1) {
                     userGoals.splice(originalIndex, 1);
                     saveState();
                     renderGoalsList();
                     renderGoalAchievements();
                 }
             }
        }

        /** Handles the click on the "Enable Notifications" button. */
        function handleRequestNotificationPermission() {
             if (!('Notification' in window)) {
                 showCelebration('Browser Not Supported', 'This browser does not support desktop notifications.', 'fa-times-circle');
                 return;
             }

             Notification.requestPermission().then(permission => {
                 checkNotificationPermission();
                 if (permission === 'granted') {
                     sendNotification("Notifications Enabled!", "You'll now get alerts for milestones.");
                 } else if (permission === 'denied') {
                     showCelebration('Notifications Blocked', 'Notifications are blocked. You can enable them in your browser settings.', 'fa-ban');
                 }
             });
        }

        /** Handles the click on a calendar day. */
        function handleCalendarDayClick(event) {
            const dayEl = event.target.closest('.calendar-day');
            if (dayEl && !dayEl.classList.contains('other-month')) {
                const fullDateIso = dayEl.dataset.fullDate;
                const clickedDate = new Date(fullDateIso);
                confirmAndAddRelapse(clickedDate);
            }
        }

        /** Handles file selection for import. */
        function handleImportFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                importStatusEl.textContent = '';
                performImportBtn.classList.add('hidden');
                importedData = null;
                return;
            }

            if (file.type !== 'application/json') {
                importStatusEl.textContent = 'Please select a JSON file.';
                importStatusEl.classList.remove('import-success');
                importStatusEl.classList.add('import-error');
                performImportBtn.classList.add('hidden');
                importedData = null;
                return;
            }

            importStatusEl.textContent = `Selected file: ${file.name}`;
            importStatusEl.classList.remove('import-error', 'import-success');
            performImportBtn.classList.remove('hidden'); // Show the "Perform Import" button

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    importedData = JSON.parse(e.target.result);
                    importStatusEl.textContent = `File loaded: ${file.name}. Click "Perform Import" to apply.`;
                    importStatusEl.classList.remove('import-error');
                    importStatusEl.classList.add('import-success');
                } catch (error) {
                    importStatusEl.textContent = 'Error parsing JSON file. Invalid format.';
                    importStatusEl.classList.remove('import-success');
                    importStatusEl.classList.add('import-error');
                    performImportBtn.classList.add('hidden');
                    importedData = null;
                }
            };
            reader.readAsText(file);
        }

        /** Handles the actual import process after file is selected and parsed. */
        function handlePerformImport() {
            if (importedData) {
                const success = applyImportedData(importedData);
                if (success) {
                    setTimeout(() => settingsModal.classList.remove('active'), 1500); // Close settings modal after successful import
                }
            } else {
                importStatusEl.textContent = 'No data loaded to import.';
                importStatusEl.classList.remove('import-success');
                importStatusEl.classList.add('import-error');
            }
        }


        // --- Event Listeners ---

        // Start Date Change
        startDateInput.addEventListener('change', (event) => {
            const selectedDateStr = event.target.value;
            if (selectedDateStr) {
                 const [year, month, day] = selectedDateStr.split('-').map(Number);
                 streakStartDate = new Date(Date.UTC(year, month - 1, day));
            } else {
                streakStartDate = null;
            }
            lastAchievedStandardBadgeThreshold = 0;
            userGoals.forEach(goal => goal.isAchieved = false);
            relapseDates = [];
            saveState();
            updateMainDisplay();
            generateCalendar(currentDisplayedDate.getFullYear(), currentDisplayedDate.getMonth());
        });

        // Add Goal Button
        addGoalBtn.addEventListener('click', handleAddGoal);

        // Add Goal on Enter key press in inputs
        newGoalDaysInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAddGoal(); });
        newGoalNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAddGoal(); });

        // Calendar Navigation
        prevMonthBtn.addEventListener('click', () => {
            currentDisplayedDate.setMonth(currentDisplayedDate.getMonth() - 1);
            generateCalendar(currentDisplayedDate.getFullYear(), currentDisplayedDate.getMonth());
        });
        nextMonthBtn.addEventListener('click', () => {
            currentDisplayedDate.setMonth(currentDisplayedDate.getMonth() + 1);
            generateCalendar(currentDisplayedDate.getFullYear(), currentDisplayedDate.getMonth());
        });

        // Modal Open Buttons
        myGoalsBtn.addEventListener('click', () => {
            renderGoalsList();
            myGoalsModal.classList.add('active');
        });
        myGoalAchievementsBtn.addEventListener('click', () => {
            renderGoalAchievements();
            myGoalAchievementsModal.classList.add('active');
        });
        viewStandardBadgesBtn.addEventListener('click', () => {
            populateStandardBadgesList();
            viewStandardBadgesModal.classList.add('active');
        });
        // New: Settings Button opens settings modal
        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('active');
            importStatusEl.textContent = ''; // Clear status when opening
            performImportBtn.classList.add('hidden'); // Hide button
            importFileInput.value = ''; // Clear file input
        });

        // Modal Close Buttons
        closeGoalsModalBtn.addEventListener('click', () => myGoalsModal.classList.remove('active'));
        closeGoalAchievementsModalBtn.addEventListener('click', () => myGoalAchievementsModal.classList.remove('active'));
        closeStandardBadgesModalBtn.addEventListener('click', () => viewStandardBadgesModal.classList.remove('active'));
        closeSettingsModalBtn.addEventListener('click', () => settingsModal.classList.remove('active')); // Close settings modal

        // Close Modals on Overlay Click
        myGoalsModal.addEventListener('click', (e) => { if (e.target === myGoalsModal) myGoalsModal.classList.remove('active'); });
        myGoalAchievementsModal.addEventListener('click', (e) => { if (e.target === myGoalAchievementsModal) myGoalAchievementsModal.classList.remove('active'); });
        viewStandardBadgesModal.addEventListener('click', (e) => { if (e.target === viewStandardBadgesModal) viewStandardBadgesModal.classList.remove('active'); });
        celebrationModal.addEventListener('click', (e) => { if (e.target === celebrationModal) celebrationModal.classList.remove('active'); });
        confirmationModal.addEventListener('click', (e) => { if (e.target === confirmationModal) { if (pendingConfirmationCallback && typeof pendingConfirmationCallback.onCancel === 'function') { pendingConfirmationCallback.onCancel(); } } });
        settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) { settingsModal.classList.remove('active'); } }); // Close settings modal on overlay click

        // Notification Prompt Button
        requestNotificationPermissionBtn.addEventListener('click', handleRequestNotificationPermission);

        // Relapse Button Event Listener
        relapseBtn.addEventListener('click', () => confirmAndAddRelapse(new Date()));

        // Confirmation Modal Buttons
        confirmYesBtn.addEventListener('click', () => {
            if (pendingConfirmationCallback && typeof pendingConfirmationCallback.onConfirm === 'function') {
                pendingConfirmationCallback.onConfirm();
            }
        });
        confirmNoBtn.addEventListener('click', () => {
            if (pendingConfirmationCallback && typeof pendingConfirmationCallback.onCancel === 'function') {
                pendingConfirmationCallback.onCancel();
            }
        });

        // Export and Import Buttons (now inside settings modal)
        exportDataBtn.addEventListener('click', exportData);
        importDataBtn.addEventListener('click', importData); // This now triggers the hidden file input

        // Import File Input and Perform Import Button Listeners
        importFileInput.addEventListener('change', handleImportFileSelect);
        performImportBtn.addEventListener('click', handlePerformImport);


        // --- Initialization ---
        window.onload = () => {
            loadState();
            scheduleDailyUpdate();
        };

    </script>
</body>
</html>
