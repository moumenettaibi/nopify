<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nopify</title> <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="https://api.cloudinary.com/v1_1/pplx/image/download?timestamp=1746370578&public_id=user_uploads%2F1428752%2FJdaGRckSlfmIJxu%2FSCR-20250504-nenx&format=jpg&signature=4cd38a510128955ae7b4be28a1ffbb21ccecb304&api_key=168798331147639" type="image/x-icon">
	<style>
        /* Custom Styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa; /* Light gray background */
            line-height: 1.5; /* Improved readability */
            padding: 1rem; /* Add default padding to body */
        }

        /* Ensure the main container is centered and has responsive max-width */
        .main-container {
             width: 100%;
             max-width: 500px; /* Increased max-width slightly for desktop */
             margin-left: auto;
             margin-right: auto;
             padding: 1.5rem; /* Responsive padding */
             background-color: #fff;
             border-radius: 0.75rem; /* Slightly more rounded */
             box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); /* Medium shadow */
        }

        /* Style for calendar day circles */
        .calendar-day {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 36px; /* Fixed size for circles */
            height: 36px;
            border-radius: 50%; /* Make it circular */
            cursor: default; /* Default cursor */
            transition: background-color 0.3s ease, color 0.3s ease; /* Smooth transition */
            user-select: none; /* Prevent text selection */
            font-size: 0.875rem; /* text-sm */
        }
        /* Adjust calendar day size on smaller screens if needed */
        @media (max-width: 360px) {
            .calendar-day {
                width: 30px;
                height: 30px;
                font-size: 0.75rem; /* text-xs */
            }
        }


        /* Style for days within the streak range - Reverted to previous orange */
        .streak-day {
            background-color: #fdba74; /* Orange-300 */
            color: #c2410c; /* Orange-700 */
            font-weight: bold;
        }
        /* Style for today's date */
        .today {
             border: 2px solid #fb923c; /* Orange-400 border */
        }
        /* Style for days from previous/next months */
        .other-month {
            color: #d1d5db; /* Gray-300 */
        }
        /* Style for calendar header (day names) */
        .calendar-header th {
            color: #6b7280; /* Gray-500 */
            font-weight: normal;
            padding-bottom: 8px;
            font-size: 0.75rem; /* text-xs */
        }
        /* Base button styling */
        button {
            padding: 0.75rem 1.5rem;
            margin: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.15s ease-in-out, opacity 0.15s ease-in-out;
        }
        /* Styling for date and number inputs */
        input[type="date"], input[type="number"], input[type="text"] { /* Added text input */
            padding: 0.5rem;
            border: 1px solid #d1d5db; /* Gray-300 border */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            /* focus:border-orange-500 focus:ring-orange-500; /* Focus styles handled by Tailwind classes in HTML */
        }
        /* Styling for the main badge icon */
        .main-badge-icon {
            font-size: 1.75rem; /* Slightly larger */
            margin-right: 0.75rem;
            width: 28px; /* Fixed width for alignment */
            text-align: center;
            color: #fb923c; /* Default orange */
        }
        /* Modal overlay styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6); /* Darker semi-transparent black */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        /* Modal content styles */
        .modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); /* Stronger shadow */
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            transform: translateY(20px); /* Start slightly below center */
            transition: transform 0.3s ease;
        }
         .modal-overlay.active .modal-content {
             transform: translateY(0); /* Slide up to center */
         }
        /* Modal close button styles */
        .modal-close-btn {
            position: absolute;
            top: 0.5rem; /* Adjusted position */
            right: 0.5rem; /* Adjusted position */
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #9ca3af; /* Gray-400 */
            cursor: pointer;
            padding: 0.25rem;
            margin: 0;
            line-height: 1;
        }
        .modal-close-btn:hover {
            color: #4b5563; /* Gray-600 */
        }
        /* List item styling in modals (badges and goal) */
        .list-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 0.75rem; /* py-3 px-3 */
            border-bottom: 1px solid #e5e7eb; /* Gray-200 */
            transition: background-color 0.2s ease;
            list-style: none; /* Removed bullet points */
        }
        .list-item:last-child {
            border-bottom: none;
        }
        .list-item .item-icon {
             font-size: 1.75rem;
             margin-right: 1rem;
             width: 28px;
             text-align: center;
             color: #9ca3af; /* Gray-400 for unachieved icons */
        }
        .list-item-details {
            flex-grow: 1;
        }
        .list-item-name {
            font-weight: 600;
            color: #374151; /* Gray-700 */
        }
        .list-item-days {
            font-size: 0.875rem;
            color: #6b7280; /* Gray-500 */
        }
        /* Style for ACHIEVED items in lists */
        .list-item.achieved {
            background-color: #fff7ed; /* Orange-50 */
            border-left: 4px solid #f97316; /* Orange-500 */
            padding-left: calc(0.75rem - 4px); /* Adjust padding for border */
        }
        .list-item.achieved .item-icon {
            color: #f97316; /* Orange-500 */
        }
         .list-item.achieved .list-item-name {
            color: #c2410c; /* Orange-700 */
        }
        /* Styling for the Custom Goal item in the Achievements list */
         .list-item.goal-item .item-icon {
             color: #34d399; /* Green-400 */
         }
          .list-item.goal-item.achieved .item-icon {
             color: #047857; /* Green-800 */
         }
           .list-item.goal-item.achieved .list-item-name {
             color: #047857; /* Green-800 */
           }
            /* Styling for the Goal Achievement Badge items */
         .list-item.goal-achievement-item .item-icon {
             color: #059669; /* Green-600 */
         }
          .list-item.goal-achievement-item .list-item-name {
             color: #065f46; /* Green-800 */
         }


         /* Styling for the goal setting section within the modal */
         .modal-goal-section {
             margin-bottom: 1.5rem;
             padding: 1.5rem; /* Increased padding */
             border: 1px solid #d1d5db; /* Gray-300 border */
             border-radius: 0.5rem; /* Rounded corners */
             background-color: #f9fafb; /* Gray-50 */
             text-align: center;
             box-shadow: inset 0 1px 3px 0 rgba(0, 0, 0, 0.08); /* Subtle inner shadow */
         }
          .modal-goal-section label {
              display: block;
              margin-bottom: 0.75rem; /* Increased margin */
              font-size: 0.9rem; /* Slightly larger font */
              font-weight: 600; /* Semibold */
              color: #374151;
          }
          /* Specific style for the number input within the modal goal section */
           .modal-goal-section input[type="number"] {
               display: inline-block;
               width: auto;
               max-width: 120px; /* Increased max-width slightly */
               margin-bottom: 0.75rem; /* Increased margin */
               text-align: center;
               padding: 0.6rem; /* Increased padding */
               font-size: 1rem; /* Larger font size */
               border-color: #9ca3af; /* Gray-400 border */
               transition: border-color 0.2s ease, box-shadow 0.2s ease;
           }
            .modal-goal-section input[type="number"]:focus {
                border-color: #f97316; /* Orange-500 on focus */
                box-shadow: 0 0 0 3px rgba(253, 186, 116, 0.5); /* Orange-300 ring on focus */
                outline: none; /* Remove default outline */
            }
            /* Style for the goal name input */
            .modal-goal-section input[type="text"] {
                 display: inline-block;
                 width: calc(100% - 140px); /* Adjust width based on number input */
                 margin-left: 0.5rem;
                 margin-bottom: 0.75rem;
                 padding: 0.6rem;
                 font-size: 1rem;
                 border-color: #d1d5db;
                 transition: border-color 0.2s ease, box-shadow 0.2s ease;
            }
             .modal-goal-section input[type="text"]:focus {
                border-color: #f97316; /* Orange-500 on focus */
                box-shadow: 0 0 0 3px rgba(253, 186, 116, 0.5); /* Orange-300 ring on focus */
                outline: none; /* Remove default outline */
            }
            /* Style for the add goal button */
            .modal-goal-section button {
                display: block; /* Make button a block element */
                width: auto; /* Auto width */
                margin: 0.75rem auto 0 auto; /* Center the button */
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
                background-color: #fb923c; /* Orange-400 */
                color: white;
                font-weight: 600;
                border: none;
                border-radius: 0.375rem;
                cursor: pointer;
                transition: background-color 0.15s ease-in-out;
            }
             .modal-goal-section button:hover {
                 background-color: #f97316; /* Orange-500 on hover */
             }


          .modal-goal-progress {
              font-size: 0.9rem; /* Slightly larger font */
              color: #4b5563; /* Gray-600 */
              font-weight: 500;
              margin-bottom: 0.75rem; /* Added margin below text */
          }
           /* Added spacing between goal section and goal item */
          #customGoalAchievementItem {
              margin-top: 1.5rem;
          }

          /* New: Progress Bar Styling */
            .progress-bar-container {
                width: 100%; /* Full width of its container */
                height: 12px; /* Fixed height */
                background-color: #e5e7eb; /* Gray-200 background */
                border-radius: 6px; /* Rounded corners */
                overflow: hidden; /* Hide overflowing fill */
                margin-top: 0.5rem; /* Space above the bar */
                box-shadow: inset 0 1px 2px rgba(0,0,0,0.1); /* Subtle inner shadow */
            }

            .progress-bar-fill {
                height: 100%;
                width: 0%; /* Start with 0 width */
                background-color: #fb923c; /* Orange-400 fill */
                border-radius: 6px;
                transition: width 0.5s ease-in-out; /* Smooth transition for width changes */
            }

            /* Style for achieved goal progress bar */
            .progress-bar-container.achieved .progress-bar-fill {
                background-color: #34d399; /* Green-400 when achieved */
            }

            /* Styling for the list of goals */
            #goalsListContainer {
                 margin-top: 1.5rem;
                 border-top: 1px solid #e5e7eb; /* Separator line */
                 padding-top: 1.5rem;
            }

            .goal-list-item {
                 display: flex;
                 flex-direction: column; /* Stack details and progress bar */
                 padding: 0.75rem 0.75rem;
                 border-bottom: 1px solid #e5e7eb;
                 list-style: none;
                 transition: background-color 0.2s ease;
            }
             .goal-list-item:last-child {
                 border-bottom: none;
             }
             .goal-list-item-header {
                 display: flex;
                 align-items: center;
                 margin-bottom: 0.5rem; /* Space between header and progress bar */
             }
             .goal-list-item .item-icon {
                 font-size: 1.5rem; /* Slightly smaller icon in list */
                 margin-right: 0.75rem;
                 width: 24px;
                 text-align: center;
                 color: #9ca3af;
             }
             .goal-list-item-details {
                 flex-grow: 1;
             }
              .goal-list-item-name {
                 font-weight: 600;
                 color: #374151;
              }
              .goal-list-item-progress-text {
                 font-size: 0.875rem;
                 color: #6b7280;
              }
              .goal-list-item .progress-bar-container {
                  margin-top: 0; /* Remove top margin from generic progress bar */
              }
               /* Style for achieved goal list item */
             .goal-list-item.achieved {
                 background-color: #d1fae5; /* Green-100 */
                 border-left: 4px solid #34d399; /* Green-400 */
                 padding-left: calc(0.75rem - 4px);
             }
              .goal-list-item.achieved .item-icon {
                 color: #047857; /* Green-800 */
              }
               .goal-list-item.achieved .goal-list-item-name {
                 color: #047857; /* Green-800 */
              }
              /* Style for the remove goal button */
              .remove-goal-btn {
                  background: none;
                  border: none;
                  color: #ef4444; /* Red-500 */
                  font-size: 1rem;
                  cursor: pointer;
                  margin-left: 0.5rem;
                  padding: 0;
                  line-height: 1;
              }
               .remove-goal-btn:hover {
                   color: #dc2626; /* Red-600 */
               }

        /* --- Celebration Modal Styles --- */
        #celebrationModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent dark background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Higher than other modals */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        #celebrationModal.active {
            opacity: 1;
            visibility: visible;
        }

        #celebrationContent {
            background: linear-gradient(to bottom right, #ffedd5, #fcd34d); /* Orange gradient */
            padding: 2rem;
            border-radius: 1rem; /* More rounded */
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3); /* Stronger shadow */
            transform: scale(0.8); /* Start slightly smaller */
            transition: transform 0.5s ease;
            color: #7c2d12; /* Dark orange text */
            font-weight: bold;
        }

        #celebrationModal.active #celebrationContent {
             transform: scale(1); /* Scale up to normal size */
        }

        #celebrationIcon {
            font-size: 4rem; /* Large icon */
            color: #f97316; /* Orange-500 */
            margin-bottom: 1rem;
            animation: pulse 1.5s infinite ease-in-out; /* Add pulse animation */
        }

         @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
         }


        #celebrationMessage {
            font-size: 1.5rem; /* Larger message text */
            margin-bottom: 0.5rem;
        }

        #celebrationDetails {
            font-size: 1.1rem; /* Slightly smaller details text */
            color: #9a3412; /* Darker orange */
        }

        /* --- Notification Permission Prompt Styles --- */
        #notificationPrompt {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #fff;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            text-align: center;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
         #notificationPrompt p {
             font-size: 0.9rem;
             color: #4b5563;
             margin-bottom: 0.75rem;
         }
          #requestNotificationPermissionBtn {
              background-color: #34d399; /* Green-400 */
              color: white;
              font-weight: 600;
              padding: 0.5rem 1rem;
              border: none;
              border-radius: 0.375rem;
              cursor: pointer;
              transition: background-color 0.15s ease-in-out;
          }
           #requestNotificationPermissionBtn:hover {
               background-color: #10b981; /* Green-500 */
           }


    </style>
</head>
<body class="flex flex-col items-center justify-start min-h-screen p-4 bg-gray-100">

    <div class="main-container">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Nopify</h1>

        <div class="mb-6 text-center">
            <label for="startDate" class="block text-sm font-medium text-gray-700 mb-2">Start Date:</label>
            <input type="date" id="startDate" name="startDate" class="mx-auto block">
        </div>

        <div class="text-center mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
             <div class="flex items-center justify-center space-x-4 mb-2">
                 <span id="streakCount" class="text-6xl font-bold text-orange-500">0</span>
                 <i class="fas fa-fire text-5xl text-orange-400"></i>
            </div>
            <p class="text-lg text-gray-700">Days Streak!</p>
            <div id="badgeDisplay" class="mt-3 flex items-center justify-center text-gray-600">
                <i id="badgeIcon" class="main-badge-icon fas fa-question-circle"></i>
                <span id="badgeName" class="font-medium">Set start date</span>
            </div>
            <p id="streakMessage" class="text-sm text-gray-500 mt-1"></p>
        </div>

        <div class="mt-6 text-center flex flex-col sm:flex-row justify-center items-center gap-2">
             <button id="myGoalsBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg w-full sm:w-auto">
                <i class="fas fa-bullseye mr-2"></i>My Goals
            </button>
             <button id="myGoalAchievementsBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg w-full sm:w-auto">
                <i class="fas fa-award mr-2"></i>My Achievements
            </button>
             <button id="viewStandardBadgesBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg w-full sm:w-auto">
                <i class="fas fa-trophy mr-2"></i>View All Badges
            </button>
        </div>

        <div id="notificationPrompt" class="hidden mt-6">
            <p>Enable browser notifications to get alerts when you achieve milestones!</p>
            <button id="requestNotificationPermissionBtn">Enable Notifications</button>
        </div>


        <div class="mt-8">
            <h2 class="text-xl font-semibold text-center text-gray-800 mb-4">Streak Calendar</h2>
            <div class="flex items-center justify-between mb-4 px-2">
                <button id="prevMonth" aria-label="Previous month" class="text-gray-600 hover:text-orange-500 transition duration-150 ease-in-out p-2 rounded-full">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h3 id="currentMonthYear" class="text-lg font-medium text-gray-700">Month Year</h3>
                <button id="nextMonth" aria-label="Next month" class="text-gray-600 hover:text-orange-500 transition duration-150 ease-in-out p-2 rounded-full">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <table class="w-full table-fixed">
                <thead class="calendar-header">
                    <tr>
                        <th class="text-center">Mo</th>
                        <th class="text-center">Tu</th>
                        <th class="text-center">We</th>
                        <th class="text-center">Th</th>
                        <th class="text-center">Fr</th>
                        <th class="text-center">Sa</th>
                        <th class="text-center">Su</th>
                    </tr>
                </thead>
                <tbody id="calendarBody" class="text-center">
                    <!-- Calendar days will be generated here -->
                </tbody>
            </table>
        </div>

    </div>

    <!-- My Goals Modal -->
    <div id="myGoalsModal" class="modal-overlay">
        <div class="modal-content">
            <button id="closeGoalsModalBtn" aria-label="Close modal" class="modal-close-btn">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="text-xl font-semibold text-center text-gray-800 mb-4">My Goals</h2>

            <div class="modal-goal-section">
                <label for="newGoalDays">Add New Goal:</label>
                <div class="flex flex-col sm:flex-row items-center justify-center gap-2 mb-2">
                    <input type="number" id="newGoalDays" name="newGoalDays" min="1" placeholder="Days" class="block w-full sm:w-auto max-w-[100px] text-center">
                    <input type="text" id="newGoalName" name="newGoalName" placeholder="Optional Name" class="block w-full sm:flex-grow">
                </div>
                <button id="addGoalBtn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold w-full sm:w-auto"> Add Goal
                </button>
            </div>

            <div id="goalsListContainer">
                <p class="text-center text-gray-500 text-sm italic p-4">No goals set yet. Add one above!</p>
                <!-- Goal items will be rendered here -->
            </div>
        </div>
    </div>

    <!-- My Goal Achievements Modal -->
    <div id="myGoalAchievementsModal" class="modal-overlay">
        <div class="modal-content">
            <button id="closeGoalAchievementsModalBtn" aria-label="Close modal" class="modal-close-btn">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="text-xl font-semibold text-center text-gray-800 mb-4">My Goal Achievements</h2>
            <div id="goalAchievementsListContainer">
                 <p class="text-center text-gray-500 text-sm italic p-4">No goals achieved yet.</p>
                 <!-- Achieved goal items will be rendered here -->
            </div>
        </div>
    </div>

    <!-- View All Standard Badges Modal -->
     <div id="viewStandardBadgesModal" class="modal-overlay">
        <div class="modal-content">
            <button id="closeStandardBadgesModalBtn" aria-label="Close modal" class="modal-close-btn">
                <i class="fas fa-times"></i>
            </button>
            <h2 class="text-xl font-semibold text-center text-gray-800 mb-4">All Standard Badges</h2>
            <div id="standardBadgesListContainer">
                 <!-- Standard badge items will be rendered here -->
            </div>
        </div>
    </div>

    <!-- Celebration Modal -->
    <div id="celebrationModal" class="modal-overlay">
        <div id="celebrationContent">
            <i id="celebrationIcon" class="fas fa-star"></i>
            <div id="celebrationMessage">Congratulations!</div>
            <div id="celebrationDetails">You achieved a milestone!</div>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        const startDateInput = document.getElementById('startDate');
        const streakCountEl = document.getElementById('streakCount');
        const streakMessageEl = document.getElementById('streakMessage');
        const calendarBody = document.getElementById('calendarBody');
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const cloneAgainBtn = document.getElementById('cloneAgainBtn');
        const badgeIconEl = document.getElementById('badgeIcon');
        const badgeNameEl = document.getElementById('badgeName');

        // Buttons to open modals
        const myGoalsBtn = document.getElementById('myGoalsBtn');
        const myGoalAchievementsBtn = document.getElementById('myGoalAchievementsBtn');
        const viewStandardBadgesBtn = document.getElementById('viewStandardBadgesBtn');

        // Notification Permission Prompt Elements
        const notificationPrompt = document.getElementById('notificationPrompt');
        const requestNotificationPermissionBtn = document.getElementById('requestNotificationPermissionBtn');

        // Modals
        const myGoalsModal = document.getElementById('myGoalsModal');
        const myGoalAchievementsModal = document.getElementById('myGoalAchievementsModal');
        const viewStandardBadgesModal = document.getElementById('viewStandardBadgesModal');
        const celebrationModal = document.getElementById('celebrationModal');

        // Close buttons for modals
        const closeGoalsModalBtn = myGoalsModal.querySelector('.modal-close-btn');
        const closeGoalAchievementsModalBtn = myGoalAchievementsModal.querySelector('.modal-close-btn');
        const closeStandardBadgesModalBtn = viewStandardBadgesModal.querySelector('.modal-close-btn');

        // Elements within My Goals Modal
        const newGoalDaysInput = document.getElementById('newGoalDays');
        const newGoalNameInput = document.getElementById('newGoalName');
        const addGoalBtn = document.getElementById('addGoalBtn');
        const goalsListContainer = document.getElementById('goalsListContainer');

        // Elements within My Goal Achievements Modal
        const goalAchievementsListContainer = document.getElementById('goalAchievementsListContainer');

        // Elements within View All Standard Badges Modal
        const standardBadgesListContainer = document.getElementById('standardBadgesListContainer');

        // Elements within Celebration Modal
        const celebrationIconEl = document.getElementById('celebrationIcon');
        const celebrationMessageEl = document.getElementById('celebrationMessage');
        const celebrationDetailsEl = document.getElementById('celebrationDetails');


        // --- State ---
        let currentDisplayedDate = new Date(); // For calendar view
        let streakStartDate = null;
        let currentStreakDays = 0;
        let userGoals = [];
        let lastAchievedStandardBadgeThreshold = 0;
        let dailyUpdateTimeoutId = null; // Store the timeout ID for the daily update

        // --- Constants ---
        const MS_PER_DAY = 1000 * 60 * 60 * 24;
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        // --- Badge Definitions --- (Sorted by threshold for simplicity in getCurrentBadge)
        const badges = [
             { name: 'Clown', threshold: 0, icon: 'fa-face-sad-tear' },
             { name: 'Noob', threshold: 1, icon: 'fa-baby' },
             { name: 'Novice', threshold: 3, icon: 'fa-seedling' },
             { name: 'Average', threshold: 7, icon: 'fa-medal' },
             { name: 'Advanced', threshold: 15, icon: 'fa-rocket' },
             { name: 'Sigma', threshold: 30, icon: 'fa-star' },
             { name: 'Chad', threshold: 45, icon: 'fa-user-astronaut' },
             { name: 'Absolute Chad', threshold: 60, icon: 'fa-gem' },
             { name: 'Giga Chad', threshold: 120, icon: 'fa-crown' },
             { name: 'Absolute Giga Chad', threshold: 365, icon: 'fa-meteor' }
        ].sort((a, b) => b.threshold - a.threshold); // Sort descending by threshold

        // --- Functions ---

        /** Calculates the difference in days between two dates (UTC). */
        function dateDiffInDays(date1, date2) {
            // console.log("dateDiffInDays called with:", date1, date2);
            const utc1 = Date.UTC(date1.getFullYear(), date1.getMonth(), date1.getDate());
            const utc2 = Date.UTC(date2.getFullYear(), date2.getMonth(), date2.getDate());
            const diff = Math.floor((utc2 - utc1) / MS_PER_DAY);
            // console.log("dateDiffInDays result:", diff);
            return diff;
        }

        /** Determines the *highest* current badge achieved based on days. */
        function getCurrentBadge(days) {
             // Assumes badges array is sorted descending by threshold
             for (const badge of badges) {
                 if (days >= badge.threshold) {
                     return badge;
                 }
             }
             // Should theoretically not be reached if Clown (threshold 0) is present
             return badges[badges.length - 1]; // Fallback to lowest threshold badge
        }

        /** Populates the standard badges list within the View All Standard Badges modal. */
        function populateStandardBadgesList() {
            standardBadgesListContainer.innerHTML = ''; // Clear existing list
            // console.log("Populating Standard Badges List...");

            // Use the globally defined badges array, sort ascending for display
            const sortedBadgesForDisplay = [...badges].sort((a, b) => a.threshold - b.threshold);

            if (sortedBadgesForDisplay.length === 0) {
                 standardBadgesListContainer.innerHTML = '<p class="text-center text-gray-500 text-sm italic p-4">No standard badges defined.</p>';
                 return;
            }

            sortedBadgesForDisplay.forEach(badge => {
                const listItem = document.createElement('div');
                listItem.className = 'list-item'; // Use generic list-item class
                const isAchieved = currentStreakDays >= badge.threshold && currentStreakDays >= 0; // Also check streak is valid

                if (isAchieved) {
                    listItem.classList.add('achieved');
                }

                listItem.innerHTML = `
                    <i class="item-icon fas ${badge.icon}"></i>
                    <div class="list-item-details">
                        <div class="list-item-name">${badge.name}</div>
                        <div class="list-item-days">${badge.threshold}+ Days</div>
                    </div>
                `;
                standardBadgesListContainer.appendChild(listItem);
            });
             // console.log("Finished populating Standard Badges List.");
        }

         /** Renders the list of user-defined goals in the My Goals modal. */
        function renderGoalsList() {
             goalsListContainer.innerHTML = ''; // Clear existing list
             // console.log("Rendering Goals List...");

            if (userGoals.length === 0) {
                 goalsListContainer.innerHTML = '<p class="text-center text-gray-500 text-sm italic p-4">No goals set yet. Add one above!</p>';
                 return;
            }

             // Sort goals by days for consistent display order
             userGoals.sort((a, b) => a.days - b.days);

            userGoals.forEach((goal, index) => {
                const goalItem = document.createElement('div');
                goalItem.className = 'goal-list-item';
                const isGoalAchieved = currentStreakDays >= goal.days && currentStreakDays >= 0;

                 if (isGoalAchieved) {
                     goalItem.classList.add('achieved');
                 }

                const percentage = isGoalAchieved ? 100 : (currentStreakDays > 0 ? Math.min((currentStreakDays / goal.days) * 100, 100) : 0);

                goalItem.innerHTML = `
                    <div class="goal-list-item-header">
                         <i class="item-icon fas fa-bullseye"></i>
                         <div class="goal-list-item-details">
                             <div class="goal-list-item-name">${goal.name ? goal.name : `Goal ${goal.days} Days`} (${goal.days} Days)</div>
                             <div class="goal-list-item-progress-text">${isGoalAchieved ? 'Achieved!' : `Progress: ${Math.max(0, currentStreakDays)} / ${goal.days} days`}</div>
                         </div>
                         <button class="remove-goal-btn" data-index="${index}" aria-label="Remove goal">
                             <i class="fas fa-times-circle"></i>
                         </button>
                    </div>
                    <div class="progress-bar-container ${isGoalAchieved ? 'achieved' : ''}">
                        <div class="progress-bar-fill" style="width: ${percentage}%;"></div>
                    </div>
                `;
                goalsListContainer.appendChild(goalItem);
            });

             // Add event listeners to remove buttons AFTER rendering
             goalsListContainer.querySelectorAll('.remove-goal-btn').forEach(button => {
                 button.addEventListener('click', handleRemoveGoal);
             });
             // console.log("Finished rendering Goals List.");
        }

        /** Renders the list of achieved user-defined goals in the My Goal Achievements modal. */
        function renderGoalAchievements() {
            goalAchievementsListContainer.innerHTML = ''; // Clear existing list
            // console.log("Rendering Goal Achievements...");

            // Filter achieved goals from the *current* state of userGoals
            const achievedGoals = userGoals.filter(goal => goal.isAchieved);

            if (achievedGoals.length === 0) {
                 goalAchievementsListContainer.innerHTML = '<p class="text-center text-gray-500 text-sm italic p-4">No goals achieved yet.</p>';
                 return;
            }

            // Sort achieved goals by days
            achievedGoals.sort((a, b) => a.days - b.days);

            achievedGoals.forEach(goal => {
                 const achievementItem = document.createElement('div');
                 achievementItem.className = 'list-item goal-achievement-item achieved'; // Always achieved style
                 achievementItem.innerHTML = `
                     <i class="item-icon fas fa-award"></i>
                     <div class="list-item-details">
                         <div class="list-item-name">Achieved: ${goal.name ? goal.name : `Goal ${goal.days} Days`}</div>
                         <div class="list-item-days">Reached at ${goal.days} days</div>
                     </div>
                 `;
                 goalAchievementsListContainer.appendChild(achievementItem);
            });
             // console.log("Finished rendering Goal Achievements.");
        }

        /** Displays a celebration message pop-up. */
        function showCelebration(message, details, iconClass = 'fa-star') {
            celebrationMessageEl.textContent = message;
            celebrationDetailsEl.textContent = details;
            celebrationIconEl.className = `fas ${iconClass} text-4xl mb-4`; // Apply classes directly

            celebrationModal.classList.add('active'); // Show the modal

            // Hide the modal after a few seconds
            setTimeout(() => {
                celebrationModal.classList.remove('active');
            }, 4000); // Display for 4 seconds
        }

        /** Sends a browser notification if permission is granted. */
        function sendNotification(title, body, icon = 'https://api.cloudinary.com/v1_1/pplx/image/download?timestamp=1746370578&public_id=user_uploads%2F1428752%2FJdaGRckSlfmIJxu%2FSCR-20250504-nenx&format=jpg&signature=4cd38a510128955ae7b4be28a1ffbb21ccecb304&api_key=168798331147639') { // Default to app icon
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body: body, icon: icon });
                // console.log("Browser notification sent:", title);
            } else {
                // console.log("Browser notification not sent (permission: " + Notification.permission + ")");
            }
        }


        /** Checks user goals against the current streak and updates their achievement status. */
        function checkAndAwardGoalBadges() {
            // console.log("Checking and Awarding Goal Badges...");
            let stateChanged = false;
            let newlyAchievedGoal = null; // Track if a goal was *just* achieved

            userGoals.forEach(goal => {
                if (!goal.isAchieved && currentStreakDays >= goal.days && currentStreakDays >= 0) {
                    // console.log(`Goal achieved: ${goal.name} (${goal.days} days)`);
                    goal.isAchieved = true;
                    stateChanged = true;
                    newlyAchievedGoal = goal; // Store the newly achieved goal
                }
            });

            // If a goal was newly achieved, trigger celebration and notification
            if (newlyAchievedGoal) {
                 const goalName = newlyAchievedGoal.name ? newlyAchievedGoal.name : `${newlyAchievedGoal.days} Days Goal`;
                 showCelebration('Goal Achieved!', goalName, 'fa-award');
                 sendNotification('Milestone Achieved!', `You reached your goal: ${goalName}!`);
            }

            // Always re-render goal lists after checking to update progress bars and states
            renderGoalsList();
            renderGoalAchievements(); // Also update the achievements list modal content

            if (stateChanged) {
                // console.log("Goal state changed, saving.");
                saveState(); // Save if any goals were newly marked as achieved
            } else {
                 // console.log("No new goals achieved.");
            }
        }


        /** Updates the main streak count and current badge display. */
        function updateMainDisplay() {
            // console.log("Updating Main Display...");
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today's date

            let previousStreakDays = currentStreakDays; // Store previous value
            let newlyAchievedStandardBadge = null; // Track if a badge was *just* achieved

            currentStreakDays = 0; // Reset before recalculation
            let currentBadge = getCurrentBadge(0); // Default

            if (streakStartDate) {
                const normalizedStartDate = new Date(streakStartDate);
                normalizedStartDate.setHours(0, 0, 0, 0);

                if (normalizedStartDate > today) {
                    // Start date is in the future - invalid state
                    currentStreakDays = -1; // Use -1 to indicate invalid
                    currentBadge = { name: 'Invalid Date', icon: 'fa-exclamation-triangle' };
                    streakMessageEl.textContent = 'Start date cannot be in the future.';
                     badgeIconEl.style.color = '#ef4444'; // Red for invalid
                     console.log("Invalid start date (future).");
                } else {
                    // Valid start date
                    currentStreakDays = dateDiffInDays(normalizedStartDate, today);
                    currentBadge = getCurrentBadge(currentStreakDays);
                    streakMessageEl.textContent = ''; // Clear any previous message
                     badgeIconEl.style.color = '#f97316'; // Default orange for valid
                     console.log(`Streak calculated: ${currentStreakDays} days.`);

                    // Check for new standard badge achievement ONLY if the streak increased
                    if (currentStreakDays > previousStreakDays && currentBadge.threshold > lastAchievedStandardBadgeThreshold && currentBadge.threshold <= currentStreakDays) {
                         console.log(`New Standard Badge Achieved: ${currentBadge.name} (${currentBadge.threshold} days)`);
                         newlyAchievedStandardBadge = currentBadge;
                         lastAchievedStandardBadgeThreshold = currentBadge.threshold; // Update threshold
                         saveState(); // Save the new threshold immediately
                    }
                }
            } else {
                // No start date set
                currentStreakDays = 0;
                currentBadge = { name: 'Set start date', icon: 'fa-question-circle' };
                streakMessageEl.textContent = '';
                 badgeIconEl.style.color = '#fb923c'; // Default orange
                lastAchievedStandardBadgeThreshold = 0; // Reset threshold if no date
                saveState(); // Save the reset threshold
                console.log("No start date set.");
            }

            // Update main streak count display
            streakCountEl.textContent = Math.max(0, currentStreakDays); // Show 0 for invalid dates too

            // Update website title
            if (currentStreakDays > 0) {
                document.title = `${currentStreakDays} Days Streak - Nopify`;
            } else if (currentStreakDays === 0 && streakStartDate !== null) {
                 document.title = `0 Day Streak - Nopify`;
            } else {
                 document.title = `Nopify`; // Default or invalid
            }

            // Update main badge display
            badgeNameEl.textContent = currentBadge.name;
            badgeIconEl.className = `main-badge-icon fas ${currentBadge.icon}`; // Apply classes

            // After updating streak, check for newly achieved GOALS
            checkAndAwardGoalBadges(); // This calls its own rendering functions

            // If a standard badge was newly achieved, trigger celebration/notification AFTER goal check
            if (newlyAchievedStandardBadge) {
                 showCelebration('New Badge!', newlyAchievedStandardBadge.name, newlyAchievedStandardBadge.icon);
                 sendNotification('New Badge Unlocked!', `You earned the ${newlyAchievedStandardBadge.name} badge for ${newlyAchievedStandardBadge.threshold} days!`);
            }


            // Re-populate the standard badges list (needed if a new one was achieved)
            populateStandardBadgesList();

             // console.log("Finished Updating Main Display.");
        }


        /** Generates and displays the calendar for a given month and year. */
        function generateCalendar(year, month) {
            calendarBody.innerHTML = ''; // Clear previous calendar
            // console.log(`Generating Calendar for ${year}-${month + 1}...`);
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today for comparison

            currentMonthYearEl.textContent = `${monthNames[month]} ${year}`;

            const firstDayOfMonth = new Date(year, month, 1);
            let startingDay = firstDayOfMonth.getDay(); // 0 (Sun) to 6 (Sat)
            startingDay = (startingDay === 0) ? 6 : startingDay - 1; // Adjust to 0 (Mon) to 6 (Sun)

            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let date = 1;
            let calendarHtml = '';

            // Calculate the date range for the streak (if applicable)
            let normalizedStartDate = null;
            if (streakStartDate) {
                normalizedStartDate = new Date(streakStartDate);
                normalizedStartDate.setHours(0, 0, 0, 0);
            }

            for (let i = 0; i < 6; i++) { // Max 6 rows needed
                calendarHtml += '<tr>';
                let rowHasDates = false; // Optimization to stop early if month ends

                for (let j = 0; j < 7; j++) { // 7 days a week (Mon-Sun)
                    if ((i === 0 && j < startingDay) || date > daysInMonth) {
                        // Empty cell before month start or after month end
                        calendarHtml += '<td><div class="calendar-day other-month"></div></td>';
                    } else {
                        // Cell for a valid day in the month
                        rowHasDates = true;
                        const currentDate = new Date(year, month, date);
                        currentDate.setHours(0, 0, 0, 0); // Normalize for comparison

                        let classes = 'calendar-day';

                        // Check if day is part of the current streak
                        if (normalizedStartDate && currentDate >= normalizedStartDate && currentDate <= today) {
                            classes += ' streak-day';
                        }

                        // Check if day is today
                        if (currentDate.getTime() === today.getTime()) {
                            classes += ' today';
                        }

                        calendarHtml += `<td><div class="${classes}">${date}</div></td>`;
                        date++;
                    }
                }
                calendarHtml += '</tr>';

                // If we've placed all the dates and the rest of the row was empty, break
                if (date > daysInMonth && !rowHasDates) {
                    break;
                }
            }
            calendarBody.innerHTML = calendarHtml;
             // console.log("Finished generating Calendar.");
        }

        /** Saves the streak start date, goals, and last badge threshold to localStorage. */
        function saveState() {
            // console.log("Saving state...");
            try {
                if (streakStartDate && !isNaN(streakStartDate.getTime())) {
                    localStorage.setItem('nopify_streakStartDate', streakStartDate.toISOString());
                } else {
                    localStorage.removeItem('nopify_streakStartDate');
                }
                localStorage.setItem('nopify_userGoals', JSON.stringify(userGoals));
                localStorage.setItem('nopify_lastAchievedStandardBadgeThreshold', lastAchievedStandardBadgeThreshold.toString());
                // console.log("State saved successfully.");
            } catch (e) {
                console.error("Error saving state to localStorage:", e);
                alert("Could not save progress. LocalStorage might be full or disabled.");
            }
        }

        /** Loads the state from localStorage. */
        function loadState() {
             console.log("Loading state...");
            try {
                // Load Start Date
                const savedDateString = localStorage.getItem('nopify_streakStartDate');
                if (savedDateString) {
                    streakStartDate = new Date(savedDateString);
                    if (isNaN(streakStartDate.getTime())) {
                        streakStartDate = null; // Invalid date stored
                        localStorage.removeItem('nopify_streakStartDate');
                    } else {
                        // Set input value correctly (YYYY-MM-DD)
                        startDateInput.value = streakStartDate.toISOString().split('T')[0];
                    }
                } else {
                    streakStartDate = null;
                    startDateInput.value = '';
                }

                // Load User Goals
                const savedGoalsString = localStorage.getItem('nopify_userGoals');
                 if (savedGoalsString) {
                     const parsedGoals = JSON.parse(savedGoalsString);
                     // Basic validation: Ensure it's an array and goals have expected properties
                     if (Array.isArray(parsedGoals) && parsedGoals.every(g => typeof g.days === 'number' && typeof g.isAchieved === 'boolean')) {
                         userGoals = parsedGoals;
                     } else {
                         console.warn("Invalid goal data found in localStorage. Resetting goals.");
                         userGoals = [];
                         localStorage.removeItem('nopify_userGoals'); // Clear invalid data
                     }
                 } else {
                     userGoals = [];
                 }


                // Load Last Achieved Standard Badge Threshold
                const savedThreshold = localStorage.getItem('nopify_lastAchievedStandardBadgeThreshold');
                lastAchievedStandardBadgeThreshold = savedThreshold ? parseInt(savedThreshold, 10) : 0;
                if (isNaN(lastAchievedStandardBadgeThreshold)) {
                    lastAchievedStandardBadgeThreshold = 0; // Reset if invalid
                }

                console.log("State loaded:", { streakStartDate, userGoals, lastAchievedStandardBadgeThreshold });

            } catch (e) {
                console.error("Error loading state from localStorage:", e);
                // Reset to defaults on error
                streakStartDate = null;
                userGoals = [];
                lastAchievedStandardBadgeThreshold = 0;
                startDateInput.value = '';
                alert("Could not load saved progress. Starting fresh.");
            }

            // Initial UI setup after loading state
            updateMainDisplay(); // Calculate initial streak, check badges/goals
            generateCalendar(currentDisplayedDate.getFullYear(), currentDisplayedDate.getMonth());
            checkNotificationPermission(); // Check and show notification prompt if needed
        }

        /** Checks notification permission and updates the UI prompt. */
        function checkNotificationPermission() {
             if (!('Notification' in window)) {
                console.warn("Browser does not support notifications.");
                notificationPrompt.style.display = 'none';
            } else if (Notification.permission === 'granted') {
                notificationPrompt.style.display = 'none';
            } else if (Notification.permission === 'denied') {
                 notificationPrompt.style.display = 'none'; // Also hide if denied
                 // Optionally, you could show a message indicating it's blocked
            } else { // 'default' state
                notificationPrompt.style.display = 'block';
            }
        }

        /** Function to run the daily update */
        function runDailyUpdate() {
            console.log("--- Running Daily Update ---");
            // Update the main display (recalculates streak, checks badges/goals)
            updateMainDisplay();
            // Regenerate the calendar ONLY if the user is currently viewing the CURRENT month/year
            const now = new Date();
            if (currentDisplayedDate.getFullYear() === now.getFullYear() &&
                currentDisplayedDate.getMonth() === now.getMonth()) {
                generateCalendar(currentDisplayedDate.getFullYear(), currentDisplayedDate.getMonth());
            }
            // Schedule the next update for the following midnight
            scheduleDailyUpdate();
        }

        /** Calculates time until next midnight and sets timeout */
        function scheduleDailyUpdate() {
            // Clear any existing timeout
            if (dailyUpdateTimeoutId) {
                clearTimeout(dailyUpdateTimeoutId);
            }

            const now = new Date();
            const tomorrow = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 1, 0, 0); // 1 minute past midnight to be safe
            const msUntilMidnight = tomorrow.getTime() - now.getTime();

            console.log(`Scheduling next daily update in ${Math.round(msUntilMidnight / 1000 / 60)} minutes.`);

            dailyUpdateTimeoutId = setTimeout(runDailyUpdate, msUntilMidnight);
        }

        // --- Event Handlers ---

        /** Handles adding a new goal. */
        function handleAddGoal() {
            const days = parseInt(newGoalDaysInput.value, 10);
            const name = newGoalNameInput.value.trim();

            if (isNaN(days) || days <= 0) {
                alert('Please enter a valid positive number of days.');
                return;
            }
            if (userGoals.some(goal => goal.days === days)) {
                alert(`A goal for ${days} days already exists.`);
                return;
            }

            const newGoal = { days: days, name: name || `Goal ${days} Days`, isAchieved: false }; // Default name if empty
            userGoals.push(newGoal);
            // userGoals.sort((a, b) => a.days - b.days); // Sorting happens in render function

            saveState();
            renderGoalsList(); // Update the list in the modal
            checkAndAwardGoalBadges(); // Check immediately if this new goal is already achieved by current streak

            newGoalDaysInput.value = '';
            newGoalNameInput.value = '';
            // console.log("New goal added:", newGoal);
        }

        /** Handles removing a goal from the list. */
        function handleRemoveGoal(event) {
             const button = event.target.closest('.remove-goal-btn');
             if (!button) return; // Should not happen but safety check

             const indexToRemove = parseInt(button.dataset.index, 10);

             // Need to find the actual goal corresponding to the displayed index
             // Re-sort before finding the item to remove based on the rendered index
             const sortedGoals = [...userGoals].sort((a, b) => a.days - b.days);
             if (indexToRemove >= 0 && indexToRemove < sortedGoals.length) {
                 const goalToRemove = sortedGoals[indexToRemove];
                 // Find the original goal in the unsorted userGoals array by its 'days' property (assuming days are unique)
                 const originalIndex = userGoals.findIndex(g => g.days === goalToRemove.days);
                 if (originalIndex !== -1) {
                     const removed = userGoals.splice(originalIndex, 1)[0];
                     // console.log("Goal removed:", removed);
                     saveState();
                     renderGoalsList(); // Re-render the goals list in the modal
                     renderGoalAchievements(); // Re-render the achievements list modal
                 } else {
                      console.error("Could not find original goal to remove.");
                 }
             } else {
                  console.warn("Invalid index for goal removal:", indexToRemove);
             }
        }

        /** Handles the click on the "Enable Notifications" button. */
        function handleRequestNotificationPermission() {
             if (!('Notification' in window)) {
                 alert("This browser does not support desktop notifications.");
                 return;
             }

             Notification.requestPermission().then(permission => {
                 console.log("Notification permission result:", permission);
                 checkNotificationPermission(); // Update UI based on the new permission status
                 if (permission === 'granted') {
                     sendNotification("Notifications Enabled!", "You'll now get alerts for milestones.");
                 } else if (permission === 'denied') {
                     alert("Notifications blocked. You can enable them in your browser settings if you change your mind.");
                 }
             });
        }

        // --- Event Listeners ---

        // Start Date Change
        startDateInput.addEventListener('change', (event) => {
            const selectedDateStr = event.target.value;
            if (selectedDateStr) {
                // Input gives date in local timezone's YYYY-MM-DD.
                // Create Date object, ensuring it represents midnight UTC on that day for consistent calculation.
                 const [year, month, day] = selectedDateStr.split('-').map(Number);
                 // Create date as UTC midnight to avoid timezone issues in calculations
                 streakStartDate = new Date(Date.UTC(year, month - 1, day)); // Month is 0-indexed
                 console.log("New streak start date (UTC):", streakStartDate);
            } else {
                streakStartDate = null;
                console.log("Streak start date cleared.");
            }
            // Reset last achieved badge threshold when date changes
            lastAchievedStandardBadgeThreshold = 0;
            // Reset goal achieved status (they will be re-evaluated by updateMainDisplay)
            userGoals.forEach(goal => goal.isAchieved = false);

            saveState();
            updateMainDisplay(); // Recalculate everything based on new date
            generateCalendar(currentDisplayedDate.getFullYear(), currentDisplayedDate.getMonth()); // Regenerate calendar view
        });

        // Add Goal Button
        addGoalBtn.addEventListener('click', handleAddGoal);

        // Add Goal on Enter key press in inputs
        newGoalDaysInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAddGoal(); });
        newGoalNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAddGoal(); });

        // Calendar Navigation
        prevMonthBtn.addEventListener('click', () => {
            currentDisplayedDate.setMonth(currentDisplayedDate.getMonth() - 1);
            generateCalendar(currentDisplayedDate.getFullYear(), currentDisplayedDate.getMonth());
        });
        nextMonthBtn.addEventListener('click', () => {
            currentDisplayedDate.setMonth(currentDisplayedDate.getMonth() + 1);
            generateCalendar(currentDisplayedDate.getFullYear(), currentDisplayedDate.getMonth());
        });

        // Modal Open Buttons
        myGoalsBtn.addEventListener('click', () => {
            renderGoalsList(); // Ensure list is up-to-date before showing
            myGoalsModal.classList.add('active');
        });
        myGoalAchievementsBtn.addEventListener('click', () => {
            renderGoalAchievements(); // Ensure list is up-to-date before showing
            myGoalAchievementsModal.classList.add('active');
        });
        viewStandardBadgesBtn.addEventListener('click', () => {
            populateStandardBadgesList(); // Ensure list is up-to-date before showing
            viewStandardBadgesModal.classList.add('active');
        });

        // Modal Close Buttons
        closeGoalsModalBtn.addEventListener('click', () => myGoalsModal.classList.remove('active'));
        closeGoalAchievementsModalBtn.addEventListener('click', () => myGoalAchievementsModal.classList.remove('active'));
        closeStandardBadgesModalBtn.addEventListener('click', () => viewStandardBadgesModal.classList.remove('active'));

        // Close Modals on Overlay Click
        myGoalsModal.addEventListener('click', (e) => { if (e.target === myGoalsModal) myGoalsModal.classList.remove('active'); });
        myGoalAchievementsModal.addEventListener('click', (e) => { if (e.target === myGoalAchievementsModal) myGoalAchievementsModal.classList.remove('active'); });
        viewStandardBadgesModal.addEventListener('click', (e) => { if (e.target === viewStandardBadgesModal) viewStandardBadgesModal.classList.remove('active'); });

        // Notification Prompt Button
        requestNotificationPermissionBtn.addEventListener('click', handleRequestNotificationPermission);

        


        // --- Initialization ---
        window.onload = () => {
            console.log("Window loaded. Initializing application...");
            loadState(); // Load saved data first
            // loadState() calls updateMainDisplay, generateCalendar, checkNotificationPermission

            scheduleDailyUpdate(); // Start the timer for automatic daily updates
            console.log("Application initialized.");
        };

    </script>
</body>
</html>
